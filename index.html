<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thynk POS v1.81 - Complete Hotel Management System</title>
    
    <!-- Working Logo & Favicon -->
    <link rel="icon" href="https://i.postimg.cc/yNQxnFd1/thynk.png" type="image/png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/yNQxnFd1/thynk.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGh5bmsgUE9TIC0gSG90ZWwgTWFuYWdlbWVudCIsInNob3J0X25hbWUiOiJUaHluayBQT1MiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzNiODJmNiIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2kucG9zdGltZy5jYy95TlF4bkZkMS90aHluay5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
    
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Thynk POS">
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f8fafc;
            --dark: #1f2937;
            --white: #ffffff;
            --border: #e5e7eb;
            --text: #374151;
            --text-light: #6b7280;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: url('https://i.postimg.cc/yNQxnFd1/thynk.png') no-repeat center;
            background-size: contain;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: var(--transition);
        }

        .logo-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--dark);
        }

        /* Main App Container */
        .app { padding: 2rem 0; min-height: calc(100vh - 80px); }

        .app-container {
            background: var(--white);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }

        .app-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .app-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* CONTEXT-AWARE Statistics Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            background: var(--light);
            gap: 1px;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            background: var(--light);
            transform: translateY(-2px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: var(--transition);
        }

        .stat-card:hover::before { transform: scaleX(1); }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: var(--white);
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light);
            padding: 0.5rem;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
            color: var(--dark);
        }

        .tab:hover { 
            background: rgba(59, 130, 246, 0.1);
            color: var(--dark);
        }
        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .tab-content { padding: 2rem; min-height: 500px; }
        .tab-pane { display: none; animation: fadeIn 0.5s ease; }
        .tab-pane.active { display: block; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before { left: 100%; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: var(--white);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: var(--white);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: var(--white);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #0891b2);
            color: var(--white);
        }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }

        /* Search Filter */
        .search-filter {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--dark);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-light);
        }

        /* Enhanced Table Tiles with Better Readability */
        .tiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
            max-height: 600px;
            overflow-y: auto;
        }

        .table-tile {
            position: relative;
            min-height: 180px;
            border-radius: 20px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            font-weight: 600;
            border: 2px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .table-tile.table.available {
            background: 
                linear-gradient(135deg, 
                    rgba(16, 185, 129, 0.15),
                    rgba(5, 150, 105, 0.1)
                ),
                linear-gradient(145deg,
                    rgba(255, 255, 255, 0.9),
                    rgba(255, 255, 255, 0.7)
                );
            border-color: rgba(16, 185, 129, 0.3);
            color: #065f46;
        }

        .table-tile.table.occupied {
            background: 
                linear-gradient(135deg, 
                    rgba(239, 68, 68, 0.15),
                    rgba(220, 38, 38, 0.1)
                ),
                linear-gradient(145deg,
                    rgba(255, 255, 255, 0.9),
                    rgba(255, 255, 255, 0.7)
                );
            border-color: rgba(239, 68, 68, 0.3);
            color: #991b1b;
        }

        .table-tile.room.available {
            background: 
                linear-gradient(135deg, 
                    rgba(59, 130, 246, 0.15),
                    rgba(37, 99, 235, 0.1)
                ),
                linear-gradient(145deg,
                    rgba(255, 255, 255, 0.9),
                    rgba(255, 255, 255, 0.7)
                );
            border-color: rgba(59, 130, 246, 0.3);
            color: #1e40af;
        }

        .table-tile.room.occupied {
            background: 
                linear-gradient(135deg, 
                    rgba(245, 158, 11, 0.15),
                    rgba(217, 119, 6, 0.1)
                ),
                linear-gradient(145deg,
                    rgba(255, 255, 255, 0.9),
                    rgba(255, 255, 255, 0.7)
                );
            border-color: rgba(245, 158, 11, 0.3);
            color: #92400e;
        }

        .table-tile:hover {
            transform: translateY(-8px) scale(1.02);
            backdrop-filter: blur(20px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 1);
        }

        .table-tile.expanded {
            min-height: auto;
        }

        .table-tile.hidden {
            display: none;
        }

        .tile-header {
            padding: 1.5rem;
            text-align: center;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
        }

        .tile-number {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: inherit;
            text-shadow: 
                0 1px 3px rgba(255, 255, 255, 0.9),
                0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .tile-info {
            font-size: 1rem;
            color: inherit;
            opacity: 0.9;
            font-weight: 700;
        }

        .tile-price {
            font-size: 0.85rem;
            margin-top: 0.25rem;
            color: inherit;
            font-weight: 700;
            opacity: 0.8;
        }

        .checkin-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            margin-top: 0.5rem;
            display: inline-block;
            color: inherit;
            font-weight: 700;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .tile-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: 
                linear-gradient(180deg,
                    rgba(255, 255, 255, 0.95),
                    rgba(255, 255, 255, 0.9)
                );
            backdrop-filter: blur(15px);
        }

        .tile-details.expanded {
            max-height: 800px;
        }

        .details-content {
            padding: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--dark);
        }

        .customer-info {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--dark);
        }

        .menu-items {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--dark);
        }

        .tile-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tile-remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .table-tile:hover .tile-remove-btn {
            opacity: 1;
            transform: scale(1);
        }

        .tile-remove-btn:hover {
            background: rgba(220, 38, 38, 0.9);
            transform: scale(1.1);
        }

        /* Enhanced Customer Input with Contact */
        .customer-search-container {
            position: relative;
        }

        .customer-search {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--dark);
        }

        .customer-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .customer-suggestions, .dish-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .customer-suggestion, .dish-suggestion {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light);
            cursor: pointer;
            transition: var(--transition);
        }

        .customer-suggestion:hover, .dish-suggestion:hover {
            background: var(--light);
        }

        .customer-suggestion:last-child, .dish-suggestion:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: var(--dark);
        }

        .suggestion-contact, .suggestion-price {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Section Separators */
        .section-header {
            background: var(--primary);
            color: var(--white);
            padding: 1rem 2rem;
            margin: 2rem 0 1rem 0;
            border-radius: var(--border-radius);
            font-weight: 700;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Compact Bulk Import Section */
        .bulk-import-section {
            background: var(--info);
            color: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .bulk-import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .bulk-import-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .bulk-import-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--white);
            color: var(--info);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .file-input-label:hover {
            background: var(--light);
            transform: translateY(-2px);
        }

        .bulk-import-section p {
            opacity: 0.9;
            font-size: 0.8rem;
            margin: 0;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-header {
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        /* Form Sections */
        .form-section {
            background: var(--light);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            display: block;
        }

        .form-section.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group { display: flex; flex-direction: column; }

        .form-label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--dark);
        }

        .form-input.big {
            padding: 1.5rem 1.25rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .form-input.small {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Type Selector Section */
        .type-selector {
            background: var(--primary);
            color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
        }

        .type-selector h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .type-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .type-btn {
            padding: 1rem 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
            background: transparent;
            color: var(--white);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .type-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .type-btn.active {
            background: var(--white);
            color: var(--primary);
            border-color: var(--white);
        }

        /* INTEGRATED: Room Check-in Modal */
        .checkin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .checkin-modal.show { display: flex; }

        .checkin-content {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        .checkin-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--info), #0891b2);
            color: var(--white);
            border-radius: var(--border-radius);
        }

        /* Enhanced Bill Display */
        .bill-display {
            max-width: 450px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .bill-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .bill-items {
            margin: 1.5rem 0;
        }

        .bill-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--light);
        }

        .bill-room-charge {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            margin: 0.5rem 0;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            font-weight: 600;
            color: var(--warning);
        }

        .bill-total {
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border);
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .bill-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Bills History Section */
        .bills-history-section {
            background: var(--primary);
            color: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .bills-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .bills-history-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .bills-history-section p {
            opacity: 0.9;
            font-size: 0.8rem;
            margin: 0;
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .card.hidden {
            display: none;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--info));
            transform: scaleX(0);
            transition: var(--transition);
        }

        .card:hover::before { transform: scaleX(1); }

        /* Controls */
        .controls {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .tile-counter {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-weight: 600;
            color: var(--dark);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
            background: var(--light);
            border-radius: 16px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* History Timeline */
        .history-timeline {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .history-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--light);
            border-radius: var(--border-radius);
            position: relative;
        }

        .history-item.hidden {
            display: none;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--primary);
            border-radius: 2px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .history-details {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .history-time {
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        /* Customer Details Section */
        .customer-details-section {
            background: var(--success);
            color: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .customer-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .customer-details-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .customer-details-section p {
            opacity: 0.9;
            font-size: 0.8rem;
            margin: 0;
        }

        /* ENHANCED: Customer Order History Modal */
        .customer-history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .customer-history-modal.show { display: flex; }

        .customer-history-content {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        .customer-profile {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
        }

        .customer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .customer-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .customer-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .customer-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .order-history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .order-history-item {
            background: var(--light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .order-date {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .order-items {
            margin: 0.5rem 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .order-total {
            font-weight: 700;
            color: var(--primary);
            text-align: right;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        /* WhatsApp and Email Share Buttons */
        .whatsapp-btn {
            background: #25d366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #128c7e;
            transform: translateY(-2px);
        }

        .email-btn {
            background: #ea4335;
            color: white;
        }

        .email-btn:hover {
            background: #d33b2c;
            transform: translateY(-2px);
        }

        /* Footer */
        .footer {
            background: var(--light);
            padding: 1rem 2rem;
            text-align: center;
            border-top: 1px solid var(--border);
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .version-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .version-badge {
            background: var(--primary);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .creator-text {
            font-weight: 500;
        }

        .free-forever-text {
            color: var(--success);
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                gap: 0.25rem;
            }

            .tab { justify-content: flex-start; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .tiles-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
            .controls { flex-direction: column; align-items: stretch; }
            .bill-actions { grid-template-columns: 1fr; }
            .version-info { flex-direction: column; gap: 0.5rem; }
            .type-buttons { grid-template-columns: 1fr; }
            .bulk-import-actions { flex-direction: column; align-items: stretch; }
            .customer-stats { grid-template-columns: repeat(2, 1fr); }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.8) translateY(-50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">Thynk POS</div>
            </div>
            <div>
                <button class="btn btn-primary" onclick="showBillsHistory()">
                    <span class="material-icons-outlined">receipt_long</span>
                    View All Bills
                </button>
            </div>
        </nav>
    </header>

    <!-- Main App -->
    <main class="app">
        <div class="container">
            <div class="app-container">
                <!-- App Header -->
                <div class="app-header">
                    <div class="app-title">Thynk POS - Complete Hotel Management</div>
                    <div class="app-subtitle">All-in-One Control for Hotels That Don't Compromise.</div>
                </div>

                <!-- CONTEXT-AWARE Statistics -->
                <div class="stats" id="mainStats">
                    <!-- Stats will be populated dynamically based on current tab -->
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('tables')">
                        <span class="material-icons-outlined">table_restaurant</span>
                        Tables
                    </button>
                    <button class="tab" onclick="switchTab('rooms')">
                        <span class="material-icons-outlined">hotel</span>
                        Rooms
                    </button>
                    <button class="tab" onclick="switchTab('menu')">
                        <span class="material-icons-outlined">restaurant_menu</span>
                        Menu Management
                    </button>
                    <button class="tab" onclick="switchTab('billing')">
                        <span class="material-icons-outlined">receipt_long</span>
                        Billing Software
                    </button>
                    <button class="tab" onclick="switchTab('customers')">
                        <span class="material-icons-outlined">people</span>
                        Customer Management
                    </button>
                    <button class="tab" onclick="switchTab('history')">
                        <span class="material-icons-outlined">history</span>
                        History & Reports
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Tables Management Tab -->
                    <div class="tab-pane active" id="tables-tab">
                        <div class="controls">
                            <h2>Restaurant Tables Management</h2>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div class="tile-counter">
                                    <span id="tableCount">0</span> Tables
                                </div>
                                <button class="btn btn-primary" onclick="addNewTable('Table')">
                                    <span class="material-icons-outlined">add</span>
                                    Add Table
                                </button>
                            </div>
                        </div>

                        <!-- Search Filter -->
                        <div class="search-filter">
                            <input type="text" class="search-input" id="tableSearchInput" placeholder="🔍 Search tables by number, status, or customer name..." onkeyup="filterTables()">
                        </div>

                        <!-- Tables Grid -->
                        <div id="tablesGrid" class="tiles-grid">
                            <!-- Tables will be populated here -->
                        </div>
                    </div>

                    <!-- Rooms Management Tab -->
                    <div class="tab-pane" id="rooms-tab">
                        <div class="controls">
                            <h2>Hotel Rooms Management</h2>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div class="tile-counter">
                                    <span id="roomCount">0</span> Rooms
                                </div>
                                <button class="btn btn-primary" onclick="addNewTable('Room')">
                                    <span class="material-icons-outlined">add</span>
                                    Add Room
                                </button>
                            </div>
                        </div>

                        <!-- Search Filter -->
                        <div class="search-filter">
                            <input type="text" class="search-input" id="roomSearchInput" placeholder="🔍 Search rooms by number, status, or customer name..." onkeyup="filterRooms()">
                        </div>

                        <!-- Rooms Grid -->
                        <div id="roomsGrid" class="tiles-grid">
                            <!-- Rooms will be populated here -->
                        </div>
                    </div>

                    <!-- Menu Management Tab -->
                    <div class="tab-pane" id="menu-tab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2>Menu Management</h2>
                            <button class="btn btn-primary" onclick="showAddMenuForm()">
                                <span class="material-icons-outlined">add</span>
                                Add Menu Item
                            </button>
                        </div>

                        <!-- Compact Bulk Import Section -->
                        <div class="bulk-import-section">
                            <div class="bulk-import-header">
                                <h3>📥 Bulk Import</h3>
                                <div class="bulk-import-actions">
                                    <button class="btn btn-sm" onclick="downloadMenuTemplate()" style="background: var(--white); color: var(--info); padding: 0.5rem 0.75rem; font-size: 0.8rem;">
                                        <span class="material-icons-outlined" style="font-size: 16px;">download</span>
                                        Template
                                    </button>
                                    <label for="menuFileInput" class="file-input-label">
                                        <span class="material-icons-outlined" style="font-size: 16px;">upload_file</span>
                                        Import
                                    </label>
                                    <input type="file" id="menuFileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="importMenuFromExcel(event)">
                                </div>
                            </div>
                            <p>Download template, fill with menu items, and import!</p>
                        </div>

                        <!-- Search Filter for Menu -->
                        <div class="search-filter">
                            <input type="text" class="search-input" id="menuSearchInput" placeholder="🔍 Search menu items by name, category, or price..." onkeyup="filterMenuItems()">
                        </div>

                        <!-- Add Menu Form -->
                        <div class="form-section" id="menuForm" style="display: none;">
                            <h3 style="margin-bottom: 1.5rem;">Add New Menu Item</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Item Name *</label>
                                    <input type="text" class="form-input" id="menuItemName" placeholder="e.g., Butter Chicken">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price (₹) *</label>
                                    <input type="number" class="form-input" id="menuItemPrice" placeholder="320" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category *</label>
                                    <select class="form-input" id="menuItemCategory">
                                        <option value="">Select Category</option>
                                        <option value="Starters">🥗 Starters</option>
                                        <option value="Main Course">🍛 Main Course</option>
                                        <option value="Dal">🍲 Dal</option>
                                        <option value="Rice">🍚 Rice</option>
                                        <option value="Bread">🍞 Bread</option>
                                        <option value="Beverages">🥤 Beverages</option>
                                        <option value="Desserts">🍰 Desserts</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-input" id="menuItemDescription" rows="3" placeholder="Describe your delicious dish..."></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-success" onclick="saveMenuItem()">
                                    <span class="material-icons-outlined">save</span>
                                    Save Menu Item
                                </button>
                                <button class="btn btn-danger" onclick="hideMenuForm()">
                                    <span class="material-icons-outlined">close</span>
                                    Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Menu Items Display -->
                        <div id="menuItems" class="card-grid">
                            <div class="empty-state">
                                <div class="empty-icon">🍽️</div>
                                <h3>No Menu Items Yet</h3>
                                <p>Add menu items manually or use bulk import</p>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Billing Software Tab -->
                    <div class="tab-pane" id="billing-tab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2>Enhanced Billing Software</h2>
                            <button class="btn btn-primary" onclick="showNewBillForm()">
                                <span class="material-icons-outlined">add</span>
                                Add Items to Order
                            </button>
                        </div>

                        <!-- Bills History Section -->
                        <div class="bills-history-section">
                            <div class="bills-history-header">
                                <h3>📋 Bills History</h3>
                                <button class="btn btn-sm" onclick="showBillsHistory()" style="background: var(--white); color: var(--primary); padding: 0.5rem 0.75rem; font-size: 0.8rem;">
                                    <span class="material-icons-outlined" style="font-size: 16px;">receipt_long</span>
                                    View All Bills
                                </button>
                            </div>
                            <p>View, share, and manage all generated bills anytime</p>
                        </div>

                        <!-- Customer Details Section -->
                        <div class="customer-details-section" id="customerDetailsSection" style="display: none;">
                            <div class="customer-details-header">
                                <h3>👤 Customer Details</h3>
                            </div>
                            <div id="customerDetailsContent">
                                <!-- Customer details will be populated here -->
                            </div>
                        </div>

                        <!-- Enhanced Billing Form -->
                        <div class="form-section" id="billForm" style="display: none;">
                            <h3 style="margin-bottom: 1.5rem;">Add Items to Order</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Table/Room FIRST *</label>
                                    <select class="form-input" id="billTableSelect" onchange="loadCustomerForTable()">
                                        <option value="">Select Table/Room</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Customer Name *</label>
                                    <div class="customer-search-container">
                                        <input type="text" class="customer-search" id="customerSearchInput" placeholder="Type customer name to search..." autocomplete="off">
                                        <div class="customer-suggestions" id="customerSuggestions"></div>
                                    </div>
                                    <input type="hidden" id="selectedCustomerId">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contact Number</label>
                                    <input type="tel" class="form-input" id="customerContactInput" placeholder="Enter contact number">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Dish *</label>
                                    <div class="customer-search-container">
                                        <input type="text" class="customer-search" id="dishSearchInput" placeholder="Type dish name or add new..." autocomplete="off">
                                        <div class="dish-suggestions" id="dishSuggestions"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price (₹) *</label>
                                    <input type="number" class="form-input" id="dishPriceInput" placeholder="Price" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quantity *</label>
                                    <input type="number" class="form-input" id="billQuantity" placeholder="Quantity" min="1" value="1">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;" id="simplifiedActions">
                                <button class="btn btn-success" onclick="addItemToTableOrder()">
                                    <span class="material-icons-outlined">add_shopping_cart</span>
                                    Add Item
                                </button>
                                <button class="btn btn-danger" onclick="hideBillForm()">
                                    <span class="material-icons-outlined">close</span>
                                    Close
                                </button>
                            </div>
                            
                            <div style="display: none; gap: 1rem; margin-top: 1rem;" id="expandedActions">
                                <button class="btn btn-primary" onclick="generateBillFromForm()">
                                    <span class="material-icons-outlined">receipt</span>
                                    Generate Bill
                                </button>
                                <button class="btn btn-warning" onclick="deleteOrderWithoutBill()">
                                    <span class="material-icons-outlined">cancel</span>
                                    Cancel Order
                                </button>
                            </div>
                        </div>

                        <!-- Active Orders Display -->
                        <div id="activeOrders" class="card-grid">
                            <div class="empty-state">
                                <div class="empty-icon">🛒</div>
                                <h3>No Active Orders</h3>
                                <p>Add items to tables to see active orders here</p>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Management Tab -->
                    <div class="tab-pane" id="customers-tab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2>Customer Management Software</h2>
                            <button class="btn btn-primary" onclick="showAddCustomerForm()">
                                <span class="material-icons-outlined">person_add</span>
                                Add New Customer
                            </button>
                        </div>

                        <!-- Compact Bulk Import Section -->
                        <div class="bulk-import-section">
                            <div class="bulk-import-header">
                                <h3>📥 Bulk Import</h3>
                                <div class="bulk-import-actions">
                                    <button class="btn btn-sm" onclick="downloadCustomerTemplate()" style="background: var(--white); color: var(--info); padding: 0.5rem 0.75rem; font-size: 0.8rem;">
                                        <span class="material-icons-outlined" style="font-size: 16px;">download</span>
                                        Template
                                    </button>
                                    <label for="customerFileInput" class="file-input-label">
                                        <span class="material-icons-outlined" style="font-size: 16px;">upload_file</span>
                                        Import
                                    </label>
                                    <input type="file" id="customerFileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="importCustomersFromExcel(event)">
                                </div>
                            </div>
                            <p>Download template, fill with customer details, and import!</p>
                        </div>

                        <!-- Search Filter for Customers -->
                        <div class="search-filter">
                            <input type="text" class="search-input" id="customerSearchFilter" placeholder="🔍 Search customers by name, phone, email, or address..." onkeyup="filterCustomers()">
                        </div>

                        <!-- Add/Edit Customer Form -->
                        <div class="form-section" id="customerForm" style="display: none;">
                            <h3 style="margin-bottom: 1.5rem;" id="customerFormTitle">Add New Customer</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Customer Name *</label>
                                    <input type="text" class="form-input" id="customerName" placeholder="Enter customer name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-input" id="customerPhone" placeholder="Enter phone number">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-input" id="customerEmail" placeholder="Enter email address">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-input" id="customerAddress" placeholder="Enter address">
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-success" onclick="saveCustomer()">
                                    <span class="material-icons-outlined">save</span>
                                    Save Customer
                                </button>
                                <button class="btn btn-danger" onclick="hideCustomerForm()">
                                    <span class="material-icons-outlined">close</span>
                                    Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Customers List -->
                        <div id="customersList" class="card-grid">
                            <div class="empty-state">
                                <div class="empty-icon">👥</div>
                                <h3>No Customers Added Yet</h3>
                                <p>Add customers manually or use bulk import</p>
                            </div>
                        </div>
                    </div>

                    <!-- History & Reports Tab -->
                    <div class="tab-pane" id="history-tab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2>History & Reports</h2>
                            <button class="btn btn-primary" onclick="clearAllHistory()">
                                <span class="material-icons-outlined">clear_all</span>
                                Clear History
                            </button>
                        </div>

                        <!-- Search Filter for History -->
                        <div class="search-filter">
                            <input type="text" class="search-input" id="historySearchInput" placeholder="🔍 Search history by customer name, table/room, or activity type..." onkeyup="filterHistory()">
                        </div>

                        <!-- History Timeline -->
                        <div class="history-timeline" id="historyTimeline">
                            <div class="empty-state">
                                <div class="empty-icon">📊</div>
                                <h3>No History Yet</h3>
                                <p>Activity history will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="version-info">
            <span class="version-badge">v1.81</span>
            <span class="creator-text">Created by Anas Lila</span>
            <span class="free-forever-text">✨ Free Forever</span>
        </div>
    </footer>

    <!-- Enhanced Add/Edit Table Modal -->
    <div class="modal" id="tableModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Table/Room</h3>
            </div>
            
            <!-- Type Selection First -->
            <div class="type-selector" id="typeSelector">
                <h3 id="typeSelectorTitle">First, Select Type</h3>
                <div class="type-buttons" id="typeButtons">
                    <button class="type-btn" id="tableTypeBtn" onclick="selectTableType('Table')">
                        <span class="material-icons-outlined">table_restaurant</span>
                        Table
                    </button>
                    <button class="type-btn" id="roomTypeBtn" onclick="selectTableType('Room')">
                        <span class="material-icons-outlined">hotel</span>
                        Room
                    </button>
                </div>
            </div>

            <div class="form-section" id="tableFormSection" style="display: none;">
                <div class="form-grid" id="tableFormGrid">
                    <div class="form-group">
                        <label class="form-label">Number *</label>
                        <input type="number" class="form-input big" id="tableNumber" placeholder="Enter Number" min="1">
                    </div>
                    <div class="form-group" id="chairsGroup">
                        <label class="form-label">Number of Chairs *</label>
                        <input type="number" class="form-input big" id="tableChairs" placeholder="Number of chairs" min="1" max="20" value="4">
                    </div>
                    <div class="form-group" id="priceGroup" style="display: none;">
                        <label class="form-label">Price per Night (₹) *</label>
                        <input type="number" class="form-input big" id="roomPrice" placeholder="Room price per night" min="0">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-success" onclick="saveTable()">
                        <span class="material-icons-outlined">save</span>
                        Save
                    </button>
                    <button class="btn btn-warning" onclick="goBackToTypeSelection()">
                        <span class="material-icons-outlined">arrow_back</span>
                        Back to Type
                    </button>
                    <button class="btn btn-danger" onclick="closeTableModal()">
                        <span class="material-icons-outlined">close</span>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- INTEGRATED: Room Check-in Modal -->
    <div class="checkin-modal" id="checkinModal">
        <div class="checkin-content">
            <div class="checkin-header">
                <h3>🏨 Room Check-in</h3>
                <p id="checkinRoomInfo">Room details will appear here</p>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Customer Name *</label>
                    <div class="customer-search-container">
                        <input type="text" class="customer-search" id="checkinCustomerSearch" placeholder="Type customer name to search..." autocomplete="off">
                        <div class="customer-suggestions" id="checkinCustomerSuggestions"></div>
                    </div>
                    <input type="hidden" id="checkinSelectedCustomerId">
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Number</label>
                    <input type="tel" class="form-input" id="checkinCustomerContact" placeholder="Enter contact number">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-success" onclick="performRoomCheckinFromModal()">
                    <span class="material-icons-outlined">login</span>
                    Check-in
                </button>
                <button class="btn btn-danger" onclick="closeCheckinModal()">
                    <span class="material-icons-outlined">close</span>
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Bill Display Modal -->
    <div class="modal" id="billModal">
        <div class="modal-content">
            <div class="bill-display" id="billDisplay">
                <!-- Bill content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Checkout Bill Sharing Modal -->
    <div class="modal" id="checkoutBillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Room Check-out Complete</h3>
            </div>
            <div id="checkoutBillContent">
                <!-- Checkout bill content will be populated here -->
            </div>
        </div>
    </div>

    <!-- NEW: Bills History Modal -->
    <div class="modal" id="billsHistoryModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">📋 All Bills History</h3>
            </div>
            <div class="search-filter">
                <input type="text" class="search-input" id="billsHistorySearch" placeholder="🔍 Search bills by customer name, bill number, or date..." onkeyup="filterBillsHistory()">
            </div>
            <div id="billsHistoryContent" style="max-height: 500px; overflow-y: auto;">
                <!-- Bills history will be populated here -->
            </div>
            <div style="margin-top: 2rem; text-align: center;">
                <button class="btn btn-primary" onclick="closeBillsHistoryModal()">
                    <span class="material-icons-outlined">close</span>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ENHANCED: Customer Order History Modal -->
    <div class="customer-history-modal" id="customerHistoryModal">
        <div class="customer-history-content">
            <div class="customer-profile" id="customerProfile">
                <!-- Customer profile will be populated here -->
            </div>
            <div class="modal-header">
                <h3>📊 Complete Order History</h3>
            </div>
            <div class="order-history-list" id="orderHistoryList">
                <!-- Order history will be populated here -->
            </div>
            <div style="margin-top: 2rem; text-align: center;">
                <button class="btn btn-primary" onclick="closeCustomerHistoryModal()">
                    <span class="material-icons-outlined">close</span>
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Enhanced Restaurant Database System
        const RestaurantDB = {
            tables: {
                save: (table) => {
                    const tables = JSON.parse(localStorage.getItem('thynk_tables') || '[]');
                    if (tables.length >= 500) {
                        showNotification('Maximum 500 tables/rooms allowed!', 'error');
                        return false;
                    }
                    const newTable = {
                        id: Date.now(),
                        number: table.number,
                        type: table.type,
                        chairs: table.chairs || 0,
                        price: table.price || 0,
                        status: 'available',
                        checkedIn: false,
                        checkInDate: null,
                        checkOutDate: null,
                        order: {
                            customerId: null,
                            customerName: '',
                            items: [],
                            total: 0
                        },
                        created: new Date().toISOString()
                    };
                    tables.push(newTable);
                    localStorage.setItem('thynk_tables', JSON.stringify(tables));
                    
                    RestaurantDB.history.add({
                        type: 'table_created',
                        title: `${table.type} ${table.number} Created`,
                        details: `New ${table.type.toLowerCase()} added with ${table.type === 'Room' ? `₹${table.price}/night` : `${table.chairs} chairs`}`,
                        icon: table.type === 'Room' ? 'hotel' : 'table_restaurant'
                    });
                    
                    return tables.length;
                },
                getAll: () => JSON.parse(localStorage.getItem('thynk_tables') || '[]'),
                getTables: () => {
                    const all = RestaurantDB.tables.getAll();
                    return all.filter(item => item.type === 'Table');
                },
                getRooms: () => {
                    const all = RestaurantDB.tables.getAll();
                    return all.filter(item => item.type === 'Room');
                },
                getAvailable: () => {
                    const tables = RestaurantDB.tables.getAll();
                    return tables.filter(table => table.status === 'available');
                },
                update: (id, updates) => {
                    const tables = RestaurantDB.tables.getAll();
                    const index = tables.findIndex(table => table.id === parseInt(id));
                    if (index !== -1) {
                        tables[index] = {...tables[index], ...updates};
                        localStorage.setItem('thynk_tables', JSON.stringify(tables));
                        return true;
                    }
                    return false;
                },
                delete: (id) => {
                    const tables = RestaurantDB.tables.getAll();
                    const table = tables.find(t => t.id === parseInt(id));
                    const remainingTables = tables.filter(table => table.id !== parseInt(id));
                    localStorage.setItem('thynk_tables', JSON.stringify(remainingTables));
                    
                    if (table) {
                        RestaurantDB.history.add({
                            type: 'table_deleted',
                            title: `${table.type} ${table.number} Deleted`,
                            details: `${table.type} removed from system`,
                            icon: 'delete'
                        });
                    }
                },
                checkIn: (id, customerInfo) => {
                    const tables = RestaurantDB.tables.getAll();
                    const index = tables.findIndex(table => table.id === parseInt(id));
                    if (index !== -1 && tables[index].type === 'Room') {
                        tables[index].checkedIn = true;
                        tables[index].status = 'occupied';
                        tables[index].checkInDate = new Date().toISOString();
                        tables[index].order.customerId = customerInfo.customerId;
                        tables[index].order.customerName = customerInfo.customerName;
                        localStorage.setItem('thynk_tables', JSON.stringify(tables));
                        
                        RestaurantDB.history.add({
                            type: 'room_checkin',
                            title: `Room ${tables[index].number} Check-in`,
                            details: `${customerInfo.customerName} checked into room ${tables[index].number}`,
                            icon: 'login',
                            customerName: customerInfo.customerName,
                            tableNumber: `Room ${tables[index].number}`
                        });
                        
                        return true;
                    }
                    return false;
                },
                checkOut: (id, generateBill = false) => {
                    const tables = RestaurantDB.tables.getAll();
                    const index = tables.findIndex(table => table.id === parseInt(id));
                    if (index !== -1 && tables[index].type === 'Room') {
                        const table = tables[index];
                        const customerName = table.order.customerName;
                        const customerId = table.order.customerId;
                        let bill = null;
                        
                        // ENHANCED: Always generate bill for checkout (even without items)
                        if (generateBill || table.order.items.length > 0 || table.checkedIn) {
                            let finalTotal = table.order.total;
                            let roomCharge = 0;
                            
                            if (table.type === 'Room' && table.price > 0) {
                                roomCharge = table.price;
                                finalTotal += roomCharge;
                            }
                            
                            bill = RestaurantDB.bills.save({
                                tableId: table.id,
                                tableNumber: `${table.type} ${table.number}`,
                                customerId: table.order.customerId,
                                customerName: table.order.customerName,
                                customerPhone: getCustomerPhone(table.order.customerId),
                                customerEmail: getCustomerEmail(table.order.customerId),
                                items: table.order.items,
                                roomCharge: roomCharge,
                                itemsTotal: table.order.total,
                                total: finalTotal
                            });
                            
                            if (table.order.customerId) {
                                RestaurantDB.customers.updateSpent(table.order.customerId, finalTotal);
                            }
                        }
                        
                        tables[index].checkedIn = false;
                        tables[index].status = 'available';
                        tables[index].checkOutDate = new Date().toISOString();
                        tables[index].order = {
                            customerId: null,
                            customerName: '',
                            items: [],
                            total: 0
                        };
                        localStorage.setItem('thynk_tables', JSON.stringify(tables));
                        
                        RestaurantDB.history.add({
                            type: 'room_checkout',
                            title: `Room ${table.number} Check-out`,
                            details: `${customerName} checked out from room ${table.number}${bill ? ' with bill generated' : ''}`,
                            icon: 'logout',
                            customerName: customerName,
                            tableNumber: `Room ${table.number}`
                        });
                        
                        return { success: true, bill: bill, table: table };
                    }
                    return { success: false };
                },
                addItemToOrder: (tableId, item, customerInfo) => {
                    const tables = RestaurantDB.tables.getAll();
                    const tableIndex = tables.findIndex(t => t.id === parseInt(tableId));
                    if (tableIndex !== -1) {
                        const table = tables[tableIndex];
                        
                        if (table.type === 'Room' && !table.checkedIn) {
                            return false;
                        }
                        
                        const existingItemIndex = table.order.items.findIndex(i => i.menuId === item.menuId);
                        if (existingItemIndex !== -1) {
                            table.order.items[existingItemIndex].quantity += item.quantity;
                            table.order.items[existingItemIndex].total = 
                                table.order.items[existingItemIndex].quantity * 
                                table.order.items[existingItemIndex].price;
                        } else {
                            table.order.items.push({
                                id: Date.now(),
                                menuId: item.menuId,
                                name: item.name,
                                price: item.price,
                                quantity: item.quantity,
                                total: item.price * item.quantity
                            });
                        }
                        
                        table.status = 'occupied';
                        table.order.customerId = customerInfo.customerId;
                        table.order.customerName = customerInfo.customerName;
                        table.order.total = table.order.items.reduce((sum, i) => sum + i.total, 0);
                        
                        localStorage.setItem('thynk_tables', JSON.stringify(tables));
                        
                        RestaurantDB.history.add({
                            type: 'item_added',
                            title: `${item.quantity}x ${item.name} Added`,
                            details: `Added to ${table.type} ${table.number} for ${customerInfo.customerName}`,
                            icon: 'restaurant_menu',
                            customerName: customerInfo.customerName,
                            tableNumber: `${table.type} ${table.number}`
                        });
                        
                        return true;
                    }
                    return false;
                },
                clearOrder: (tableId, isCancellation = false) => {
                    const tables = RestaurantDB.tables.getAll();
                    const tableIndex = tables.findIndex(t => t.id === parseInt(tableId));
                    if (tableIndex !== -1) {
                        const table = tables[tableIndex];
                        const customerName = table.order.customerName;
                        const itemCount = table.order.items.length;
                        
                        if (!isCancellation && itemCount > 0) {
                            RestaurantDB.history.add({
                                type: 'order_cleared',
                                title: `Order Cleared - ${table.type} ${table.number}`,
                                details: `${itemCount} items cleared for ${customerName}`,
                                icon: 'clear',
                                customerName: customerName,
                                tableNumber: `${table.type} ${table.number}`
                            });
                        }
                        
                        if (table.type === 'Room') {
                            table.order = {
                                customerId: table.order.customerId,
                                customerName: table.order.customerName,
                                items: [],
                                total: 0
                            };
                        } else {
                            table.status = 'available';
                            table.order = {
                                customerId: null,
                                customerName: '',
                                items: [],
                                total: 0
                            };
                        }
                        
                        localStorage.setItem('thynk_tables', JSON.stringify(tables));
                        return true;
                    }
                    return false;
                }
            },
            menu: {
                save: (item) => {
                    const menu = JSON.parse(localStorage.getItem('thynk_menu') || '[]');
                    const newItem = {
                        id: Date.now(),
                        name: item.name,
                        price: parseFloat(item.price),
                        category: item.category,
                        description: item.description || '',
                        created: new Date().toISOString()
                    };
                    menu.push(newItem);
                    localStorage.setItem('thynk_menu', JSON.stringify(menu));
                    
                    RestaurantDB.history.add({
                        type: 'menu_added',
                        title: `Menu Item "${item.name}" Added`,
                        details: `${item.category} - ₹${item.price}`,
                        icon: 'restaurant_menu'
                    });
                    
                    return newItem.id;
                },
                getAll: () => JSON.parse(localStorage.getItem('thynk_menu') || '[]'),
                search: (query) => {
                    const menu = RestaurantDB.menu.getAll();
                    if (!query.trim()) return [];
                    
                    const lowerQuery = query.toLowerCase();
                    return menu.filter(item => 
                        item.name.toLowerCase().includes(lowerQuery)
                    ).slice(0, 5);
                },
                update: (id, updates) => {
                    const menu = RestaurantDB.menu.getAll();
                    const index = menu.findIndex(item => item.id === parseInt(id));
                    if (index !== -1) {
                        menu[index] = {...menu[index], ...updates};
                        localStorage.setItem('thynk_menu', JSON.stringify(menu));
                        return true;
                    }
                    return false;
                },
                delete: (id) => {
                    const menu = RestaurantDB.menu.getAll();
                    const item = menu.find(m => m.id === parseInt(id));
                    const remainingMenu = menu.filter(item => item.id !== parseInt(id));
                    localStorage.setItem('thynk_menu', JSON.stringify(remainingMenu));
                    
                    if (item) {
                        RestaurantDB.history.add({
                            type: 'menu_deleted',
                            title: `Menu Item "${item.name}" Deleted`,
                            details: `Removed from menu`,
                            icon: 'delete'
                        });
                    }
                }
            },
            customers: {
                save: (customer) => {
                    const customers = JSON.parse(localStorage.getItem('thynk_customers') || '[]');
                    
                    // Check if customer already exists to prevent duplicates
                    const existingCustomer = customers.find(c => 
                        c.name.toLowerCase() === customer.name.toLowerCase() && 
                        c.phone === customer.phone
                    );
                    
                    if (existingCustomer) {
                        return existingCustomer.id;
                    }
                    
                    const newCustomer = {
                        id: Date.now(),
                        name: customer.name,
                        phone: customer.phone,
                        email: customer.email || '',
                        address: customer.address || '',
                        created: new Date().toISOString(),
                        totalOrders: 0,
                        totalSpent: 0,
                        totalVisits: 0,
                        lastVisit: null
                    };
                    customers.push(newCustomer);
                    localStorage.setItem('thynk_customers', JSON.stringify(customers));
                    
                    RestaurantDB.history.add({
                        type: 'customer_added',
                        title: `Customer "${customer.name}" Added`,
                        details: `Phone: ${customer.phone}`,
                        icon: 'person_add',
                        customerName: customer.name
                    });
                    
                    return newCustomer.id;
                },
                getAll: () => JSON.parse(localStorage.getItem('thynk_customers') || '[]'),
                search: (query) => {
                    const customers = RestaurantDB.customers.getAll();
                    if (!query.trim()) return [];
                    
                    const lowerQuery = query.toLowerCase();
                    return customers.filter(customer => 
                        customer.name.toLowerCase().includes(lowerQuery) ||
                        customer.phone.includes(query) ||
                        customer.email.toLowerCase().includes(lowerQuery)
                    ).slice(0, 5);
                },
                update: (id, updates) => {
                    const customers = RestaurantDB.customers.getAll();
                    const index = customers.findIndex(customer => customer.id === parseInt(id));
                    if (index !== -1) {
                        customers[index] = {...customers[index], ...updates};
                        localStorage.setItem('thynk_customers', JSON.stringify(customers));
                        return true;
                    }
                    return false;
                },
                delete: (id) => {
                    const customers = RestaurantDB.customers.getAll();
                    const customer = customers.find(c => c.id === parseInt(id));
                    const remainingCustomers = customers.filter(customer => customer.id !== parseInt(id));
                    localStorage.setItem('thynk_customers', JSON.stringify(remainingCustomers));
                    
                    if (customer) {
                        RestaurantDB.history.add({
                            type: 'customer_deleted',
                            title: `Customer "${customer.name}" Deleted`,
                            details: `Removed from customer database`,
                            icon: 'person_remove'
                        });
                    }
                    return true;
                },
                updateSpent: (customerId, amount) => {
                    const customers = RestaurantDB.customers.getAll();
                    const customerIndex = customers.findIndex(c => c.id === parseInt(customerId));
                    if (customerIndex !== -1) {
                        customers[customerIndex].totalOrders += 1;
                        customers[customerIndex].totalSpent += amount;
                        customers[customerIndex].lastVisit = new Date().toISOString();
                        localStorage.setItem('thynk_customers', JSON.stringify(customers));
                    }
                },
                getOrderHistory: (customerId) => {
                    const bills = RestaurantDB.bills.getAll();
                    return bills.filter(bill => bill.customerId == customerId)
                                .sort((a, b) => new Date(b.date) - new Date(a.date));
                }
            },
            bills: {
                save: (bill) => {
                    const bills = JSON.parse(localStorage.getItem('thynk_bills') || '[]');
                    const newBill = {
                        id: Date.now(),
                        ...bill,
                        date: new Date().toISOString()
                    };
                    bills.push(newBill);
                    localStorage.setItem('thynk_bills', JSON.stringify(bills));
                    
                    RestaurantDB.history.add({
                        type: 'bill_generated',
                        title: `Bill Generated - ₹${bill.total.toFixed(2)}`,
                        details: `${bill.tableNumber} for ${bill.customerName} (${bill.items.length} items)`,
                        icon: 'receipt',
                        customerName: bill.customerName,
                        tableNumber: bill.tableNumber
                    });
                    
                    return newBill;
                },
                getAll: () => JSON.parse(localStorage.getItem('thynk_bills') || '[]'),
                getTodaysBills: () => {
                    const bills = RestaurantDB.bills.getAll();
                    const today = new Date().toDateString();
                    return bills.filter(bill => new Date(bill.date).toDateString() === today);
                },
                delete: (id) => {
                    const bills = RestaurantDB.bills.getAll().filter(bill => bill.id !== parseInt(id));
                    localStorage.setItem('thynk_bills', JSON.stringify(bills));
                    return true;
                }
            },
            history: {
                add: (entry) => {
                    const history = JSON.parse(localStorage.getItem('thynk_history') || '[]');
                    const newEntry = {
                        id: Date.now(),
                        ...entry,
                        timestamp: new Date().toISOString()
                    };
                    history.unshift(newEntry);
                    
                    if (history.length > 100) {
                        history.splice(100);
                    }
                    
                    localStorage.setItem('thynk_history', JSON.stringify(history));
                },
                getAll: () => JSON.parse(localStorage.getItem('thynk_history') || '[]'),
                clear: () => {
                    localStorage.setItem('thynk_history', '[]');
                }
            }
        };

        // Global Variables
        let currentTab = 'tables';
        let editingTableId = null;
        let editingCustomerId = null;
        let selectedTableType = null;
        let expandedTileId = null;
        let selectedCustomerData = null;
        let selectedDishData = null;
        let selectedRoomForCheckin = null;

        // CONTEXT-AWARE Tab switching with dynamic stats
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            currentTab = tabName;
            
            // Load tab content
            if (tabName === 'tables') loadTables();
            if (tabName === 'rooms') loadRooms();
            if (tabName === 'menu') loadMenuItems();
            if (tabName === 'billing') { 
                loadActiveOrders(); 
                loadBillingDropdowns(); 
                setTimeout(setupDishSearch, 100);
                setTimeout(setupCustomerSearch, 100);
            }
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'history') loadHistory();
            
            // Update context-aware statistics
            updateContextStats(tabName);
        }

        // FIXED: Context-Aware Statistics Update (Fixed duplicate stats issue)
        function updateContextStats(tabName) {
            const statsContainer = document.getElementById('mainStats');
            
            if (tabName === 'tables') {
                const tables = RestaurantDB.tables.getTables();
                const availableTables = tables.filter(t => t.status === 'available').length;
                const occupiedTables = tables.filter(t => t.status === 'occupied').length;
                const todaysBills = RestaurantDB.bills.getTodaysBills();
                const todayAmount = todaysBills.reduce((sum, bill) => sum + bill.total, 0);
                const pendingTables = tables.filter(t => t.status === 'occupied' && t.order.items.length > 0);
                const pendingAmount = pendingTables.reduce((sum, table) => sum + table.order.total, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">table_restaurant</span></div>
                        <div class="stat-value">${availableTables}</div>
                        <div class="stat-label">Available Tables</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">people</span></div>
                        <div class="stat-value">${occupiedTables}</div>
                        <div class="stat-label">Occupied Tables</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">today</span></div>
                        <div class="stat-value">${todaysBills.length}</div>
                        <div class="stat-label">Today's Bills</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">attach_money</span></div>
                        <div class="stat-value">₹${todayAmount.toFixed(0)}</div>
                        <div class="stat-label">Today's Collection</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">pending</span></div>
                        <div class="stat-value">₹${pendingAmount.toFixed(0)}</div>
                        <div class="stat-label">Pending Collection</div>
                    </div>
                `;
} else if (tabName === 'rooms') {
                const rooms = RestaurantDB.tables.getRooms();
                const availableRooms = rooms.filter(r => r.status === 'available').length;
                const occupiedRooms = rooms.filter(r => r.status === 'occupied').length;
                const todaysBills = RestaurantDB.bills.getTodaysBills();
                const todayAmount = todaysBills.reduce((sum, bill) => sum + bill.total, 0);
                const pendingRooms = rooms.filter(r => r.status === 'occupied' && r.order.items.length > 0);
                const pendingAmount = pendingRooms.reduce((sum, room) => sum + room.order.total + room.price, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">hotel</span></div>
                        <div class="stat-value">${availableRooms}</div>
                        <div class="stat-label">Available Rooms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">people</span></div>
                        <div class="stat-value">${occupiedRooms}</div>
                        <div class="stat-label">Occupied Rooms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">today</span></div>
                        <div class="stat-value">${todaysBills.length}</div>
                        <div class="stat-label">Today's Bills</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">attach_money</span></div>
                        <div class="stat-value">₹${todayAmount.toFixed(0)}</div>
                        <div class="stat-label">Today's Collection</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">pending</span></div>
                        <div class="stat-value">₹${pendingAmount.toFixed(0)}</div>
                        <div class="stat-label">Pending Collection</div>
                    </div>
                `;
            } else if (tabName === 'menu') {
                const menuItems = RestaurantDB.menu.getAll();
                const categories = [...new Set(menuItems.map(item => item.category))].length;
                const avgPrice = menuItems.length > 0 ? menuItems.reduce((sum, item) => sum + item.price, 0) / menuItems.length : 0;
                const todaysBills = RestaurantDB.bills.getTodaysBills();
                const todayAmount = todaysBills.reduce((sum, bill) => sum + bill.total, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">restaurant_menu</span></div>
                        <div class="stat-value">${menuItems.length}</div>
                        <div class="stat-label">Total Menu Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">category</span></div>
                        <div class="stat-value">${categories}</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">trending_up</span></div>
                        <div class="stat-value">₹${avgPrice.toFixed(0)}</div>
                        <div class="stat-label">Average Price</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">today</span></div>
                        <div class="stat-value">${todaysBills.length}</div>
                        <div class="stat-label">Today's Bills</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">attach_money</span></div>
                        <div class="stat-value">₹${todayAmount.toFixed(0)}</div>
                        <div class="stat-label">Today's Collection</div>
                    </div>
                `;
            } else if (tabName === 'billing') {
                const activeOrders = RestaurantDB.tables.getAll().filter(t => t.status === 'occupied' && t.order.items.length > 0);
                const todaysBills = RestaurantDB.bills.getTodaysBills();
                const todayAmount = todaysBills.reduce((sum, bill) => sum + bill.total, 0);
                const pendingAmount = activeOrders.reduce((sum, table) => {
                    const tableTotal = table.order.total + (table.type === 'Room' ? table.price : 0);
                    return sum + tableTotal;
                }, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">shopping_cart</span></div>
                        <div class="stat-value">${activeOrders.length}</div>
                        <div class="stat-label">Active Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">today</span></div>
                        <div class="stat-value">${todaysBills.length}</div>
                        <div class="stat-label">Today's Bills</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">attach_money</span></div>
                        <div class="stat-value">₹${todayAmount.toFixed(0)}</div>
                        <div class="stat-label">Today's Collection</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">pending</span></div>
                        <div class="stat-value">₹${pendingAmount.toFixed(0)}</div>
                        <div class="stat-label">Pending Collection</div>
                    </div>
                `;
            } else if (tabName === 'customers') {
                const customers = RestaurantDB.customers.getAll();
                const totalSpent = customers.reduce((sum, customer) => sum + customer.totalSpent, 0);
                const totalOrders = customers.reduce((sum, customer) => sum + customer.totalOrders, 0);
                const avgSpentPerCustomer = customers.length > 0 ? totalSpent / customers.length : 0;
                const todaysBills = RestaurantDB.bills.getTodaysBills();
                const todayAmount = todaysBills.reduce((sum, bill) => sum + bill.total, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">people</span></div>
                        <div class="stat-value">${customers.length}</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">receipt_long</span></div>
                        <div class="stat-value">${totalOrders}</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">attach_money</span></div>
                        <div class="stat-value">₹${totalSpent.toFixed(0)}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">trending_up</span></div>
                        <div class="stat-value">₹${avgSpentPerCustomer.toFixed(0)}</div>
                        <div class="stat-label">Avg per Customer</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">today</span></div>
                        <div class="stat-value">${todaysBills.length}</div>
                        <div class="stat-label">Today's Bills</div>
                    </div>
                `;
            } else if (tabName === 'history') {
                const history = RestaurantDB.history.getAll();
                const todaysBills = RestaurantDB.bills.getTodaysBills();
                const todayAmount = todaysBills.reduce((sum, bill) => sum + bill.total, 0);
                const bills = RestaurantDB.bills.getAll();
                const totalRevenue = bills.reduce((sum, bill) => sum + bill.total, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">history</span></div>
                        <div class="stat-value">${history.length}</div>
                        <div class="stat-label">Total Activities</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">receipt_long</span></div>
                        <div class="stat-value">${bills.length}</div>
                        <div class="stat-label">All Time Bills</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">attach_money</span></div>
                        <div class="stat-value">₹${totalRevenue.toFixed(0)}</div>
                        <div class="stat-label">All Time Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">today</span></div>
                        <div class="stat-value">${todaysBills.length}</div>
                        <div class="stat-label">Today's Bills</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons-outlined">trending_up</span></div>
                        <div class="stat-value">₹${todayAmount.toFixed(0)}</div>
                        <div class="stat-label">Today's Collection</div>
                    </div>
                `;
            }
        }

        // Search Filter Functions
        function filterTables() {
            const searchQuery = document.getElementById('tableSearchInput').value.toLowerCase();
            const tables = RestaurantDB.tables.getTables();
            
            tables.forEach(table => {
                const tile = document.getElementById(`tile-${table.id}`);
                if (tile) {
                    const shouldShow = 
                        table.number.toString().includes(searchQuery) ||
                        table.type.toLowerCase().includes(searchQuery) ||
                        table.status.toLowerCase().includes(searchQuery) ||
                        (table.order.customerName && table.order.customerName.toLowerCase().includes(searchQuery));
                    
                    if (shouldShow) {
                        tile.classList.remove('hidden');
                    } else {
                        tile.classList.add('hidden');
                    }
                }
            });
        }

        function filterRooms() {
            const searchQuery = document.getElementById('roomSearchInput').value.toLowerCase();
            const rooms = RestaurantDB.tables.getRooms();
            
            rooms.forEach(room => {
                const tile = document.getElementById(`tile-${room.id}`);
                if (tile) {
                    const shouldShow = 
                        room.number.toString().includes(searchQuery) ||
                        room.type.toLowerCase().includes(searchQuery) ||
                        room.status.toLowerCase().includes(searchQuery) ||
                        (room.order.customerName && room.order.customerName.toLowerCase().includes(searchQuery));
                    
                    if (shouldShow) {
                        tile.classList.remove('hidden');
                    } else {
                        tile.classList.add('hidden');
                    }
                }
            });
        }

        // Menu Search Filter Function
        function filterMenuItems() {
            const searchQuery = document.getElementById('menuSearchInput').value.toLowerCase();
            const menuItems = RestaurantDB.menu.getAll();
            
            menuItems.forEach(item => {
                const card = document.querySelector(`[data-menu-id="${item.id}"]`);
                if (card) {
                    const shouldShow = 
                        item.name.toLowerCase().includes(searchQuery) ||
                        item.category.toLowerCase().includes(searchQuery) ||
                        item.price.toString().includes(searchQuery) ||
                        (item.description && item.description.toLowerCase().includes(searchQuery));
                    
                    if (shouldShow) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                }
            });

            const visibleCards = document.querySelectorAll('#menuItems .card:not(.hidden)');
            const emptyState = document.querySelector('#menuItems .empty-state');
            if (emptyState) {
                emptyState.style.display = visibleCards.length === 0 && searchQuery ? 'block' : (menuItems.length === 0 ? 'block' : 'none');
            }
        }

        // Customer Search Filter Function
        function filterCustomers() {
            const searchQuery = document.getElementById('customerSearchFilter').value.toLowerCase();
            const customers = RestaurantDB.customers.getAll();
            
            customers.forEach(customer => {
                const card = document.querySelector(`[data-customer-id="${customer.id}"]`);
                if (card) {
                    const shouldShow = 
                        customer.name.toLowerCase().includes(searchQuery) ||
                        customer.phone.includes(searchQuery) ||
                        customer.email.toLowerCase().includes(searchQuery) ||
                        customer.address.toLowerCase().includes(searchQuery);
                    
                    if (shouldShow) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                }
            });

            const visibleCards = document.querySelectorAll('#customersList .card:not(.hidden)');
            const emptyState = document.querySelector('#customersList .empty-state');
            if (emptyState) {
                emptyState.style.display = visibleCards.length === 0 && searchQuery ? 'block' : (customers.length === 0 ? 'block' : 'none');
            }
        }

        // History Search Filter Function
        function filterHistory() {
            const searchQuery = document.getElementById('historySearchInput').value.toLowerCase();
            const historyItems = RestaurantDB.history.getAll();
            
            historyItems.forEach(item => {
                const historyElement = document.querySelector(`[data-history-id="${item.id}"]`);
                if (historyElement) {
                    const shouldShow = 
                        item.title.toLowerCase().includes(searchQuery) ||
                        item.details.toLowerCase().includes(searchQuery) ||
                        (item.customerName && item.customerName.toLowerCase().includes(searchQuery)) ||
                        (item.tableNumber && item.tableNumber.toLowerCase().includes(searchQuery));
                    
                    if (shouldShow) {
                        historyElement.classList.remove('hidden');
                    } else {
                        historyElement.classList.add('hidden');
                    }
                }
            });

            const visibleItems = document.querySelectorAll('#historyTimeline .history-item:not(.hidden)');
            const emptyState = document.querySelector('#historyTimeline .empty-state');
            if (emptyState) {
                emptyState.style.display = visibleItems.length === 0 && searchQuery ? 'block' : (historyItems.length === 0 ? 'block' : 'none');
            }
        }

        // NEW: Bills History Filter Function
        function filterBillsHistory() {
            const searchQuery = document.getElementById('billsHistorySearch').value.toLowerCase();
            const billItems = document.querySelectorAll('[data-bill-id]');
            
            billItems.forEach(billItem => {
                const billData = billItem.getAttribute('data-bill-search');
                const shouldShow = billData.toLowerCase().includes(searchQuery);
                
                if (shouldShow) {
                    billItem.classList.remove('hidden');
                } else {
                    billItem.classList.add('hidden');
                }
            });

            const visibleItems = document.querySelectorAll('#billsHistoryContent .card:not(.hidden)');
            const emptyState = document.querySelector('#billsHistoryContent .empty-state');
            if (emptyState) {
                emptyState.style.display = visibleItems.length === 0 && searchQuery ? 'block' : 'none';
            }
        }

        // Setup Dish Search with Auto Price Load
        function setupDishSearch() {
            const dishInput = document.getElementById('dishSearchInput');
            const dishSuggestions = document.getElementById('dishSuggestions');
            const priceInput = document.getElementById('dishPriceInput');

            if (!dishInput) return;

            dishInput.addEventListener('input', function() {
                const query = this.value.trim();
                selectedDishData = null;
                priceInput.value = '';

                if (query.length < 1) {
                    dishSuggestions.style.display = 'none';
                    return;
                }

                const menu = RestaurantDB.menu.getAll();
                const matches = menu.filter(dish => 
                    dish.name.toLowerCase().includes(query.toLowerCase())
                );

                if (matches.length > 0) {
                    dishSuggestions.innerHTML = matches.map(dish => `
                        <div class="dish-suggestion" onclick="selectDish(${dish.id}, '${dish.name.replace(/'/g, "\\'")}', ${dish.price.toFixed(2)})">
                            <span class="suggestion-name">${dish.name}</span>
                            <span class="suggestion-price">₹${dish.price.toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    dishSuggestions.innerHTML = `
                        <div class="dish-suggestion" onclick="addNewDishPrompt('${query.replace(/'/g, "\\'")}')">
                            <span class="suggestion-name">+ Add new dish: "${query}"</span>
                            <span class="suggestion-price">Click to add & enter price</span>
                        </div>
                    `;
                }
                dishSuggestions.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!dishInput.contains(e.target) && !dishSuggestions.contains(e.target)) {
                    dishSuggestions.style.display = 'none';
                }
            });
        }

        function selectDish(id, name, price) {
            selectedDishData = { id, name, price };
            document.getElementById('dishSearchInput').value = name;
            document.getElementById('dishPriceInput').value = price.toFixed(2);
            document.getElementById('dishSuggestions').style.display = 'none';
        }

        function addNewDishPrompt(name) {
            selectedDishData = null;
            document.getElementById('dishSearchInput').value = name;
            document.getElementById('dishPriceInput').value = '';
            document.getElementById('dishPriceInput').focus();
            document.getElementById('dishSuggestions').style.display = 'none';
        }

        // Customer Search with Contact Management
        function setupCustomerSearch() {
            const searchInput = document.getElementById('customerSearchInput');
            const suggestionsDiv = document.getElementById('customerSuggestions');
            const selectedCustomerIdInput = document.getElementById('selectedCustomerId');
            const contactInput = document.getElementById('customerContactInput');

            if (!searchInput) return;

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    selectedCustomerIdInput.value = '';
                    contactInput.value = '';
                    selectedCustomerData = null;
                    document.getElementById('customerDetailsSection').style.display = 'none';
                    return;
                }

                const customers = RestaurantDB.customers.search(query);
                
                if (customers.length > 0) {
                    suggestionsDiv.innerHTML = customers.map(customer => {
                        let contactInfo = customer.phone || customer.email || customer.address || '';
                        
                        return `
                            <div class="customer-suggestion" onclick="selectCustomerWithContact(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${contactInfo}')">
                                <div class="suggestion-name">${customer.name}</div>
                                ${contactInfo ? `<div class="suggestion-contact">${contactInfo}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.innerHTML = `
                        <div class="customer-suggestion" onclick="selectNewCustomerWithContact('${query}')">
                            <div class="suggestion-name">+ Add "${query}" as new customer</div>
                            <div class="suggestion-contact">Click to add to customer database</div>
                        </div>
                    `;
                    suggestionsDiv.style.display = 'block';
                }
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        function selectCustomerWithContact(customerId, customerName, contactInfo) {
            document.getElementById('customerSearchInput').value = customerName;
            document.getElementById('selectedCustomerId').value = customerId;
            document.getElementById('customerContactInput').value = contactInfo;
            document.getElementById('customerSuggestions').style.display = 'none';
            
            selectedCustomerData = {
                id: customerId,
                name: customerName,
                contact: contactInfo
            };

            showCustomerDetails(customerId, customerName, contactInfo);
        }

        function selectNewCustomerWithContact(customerName) {
            document.getElementById('customerSearchInput').value = customerName;
            document.getElementById('selectedCustomerId').value = 'new';
            document.getElementById('customerContactInput').value = '';
            document.getElementById('customerSuggestions').style.display = 'none';
            
            selectedCustomerData = {
                id: 'new',
                name: customerName,
                contact: ''
            };
            
            document.getElementById('customerContactInput').focus();
        }

        function showCustomerDetails(customerId, customerName, contactInfo) {
            const customerDetailsSection = document.getElementById('customerDetailsSection');
            const customerDetailsContent = document.getElementById('customerDetailsContent');
            
            if (customerId && customerId !== 'new') {
                const customers = RestaurantDB.customers.getAll();
                const customer = customers.find(c => c.id == customerId);
                
                if (customer) {
                    customerDetailsContent.innerHTML = `
                        <p><strong>Name:</strong> ${customer.name}</p>
                        <p><strong>Phone:</strong> ${customer.phone || 'N/A'}</p>
                        <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                        <p><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                        <p><strong>Total Orders:</strong> ${customer.totalOrders}</p>
                        <p><strong>Total Spent:</strong> ₹${customer.totalSpent.toFixed(2)}</p>
                        ${customer.lastVisit ? `<p><strong>Last Visit:</strong> ${new Date(customer.lastVisit).toLocaleDateString()}</p>` : ''}
                    `;
                    customerDetailsSection.style.display = 'block';
                }
            } else {
                customerDetailsContent.innerHTML = `
                    <p><strong>New Customer:</strong> ${customerName}</p>
                    <p><strong>Contact:</strong> ${contactInfo || 'To be added'}</p>
                    <p><em>This customer will be added to the database</em></p>
                `;
                customerDetailsSection.style.display = 'block';
            }
        }

        // INTEGRATED: Check-in Customer Search Setup
        function setupCheckinCustomerSearch() {
            const searchInput = document.getElementById('checkinCustomerSearch');
            const suggestionsDiv = document.getElementById('checkinCustomerSuggestions');
            const selectedCustomerIdInput = document.getElementById('checkinSelectedCustomerId');
            const contactInput = document.getElementById('checkinCustomerContact');

            if (!searchInput) return;

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    selectedCustomerIdInput.value = '';
                    contactInput.value = '';
                    return;
                }

                const customers = RestaurantDB.customers.search(query);
                
                if (customers.length > 0) {
                    suggestionsDiv.innerHTML = customers.map(customer => {
                        let contactInfo = customer.phone || customer.email || customer.address || '';
                        
                        return `
                            <div class="customer-suggestion" onclick="selectCheckinCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${contactInfo}')">
                                <div class="suggestion-name">${customer.name}</div>
                                ${contactInfo ? `<div class="suggestion-contact">${contactInfo}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.innerHTML = `
                        <div class="customer-suggestion" onclick="selectNewCheckinCustomer('${query}')">
                            <div class="suggestion-name">+ Add "${query}" as new customer</div>
                            <div class="suggestion-contact">Click to add to customer database</div>
                        </div>
                    `;
                    suggestionsDiv.style.display = 'block';
                }
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        function selectCheckinCustomer(customerId, customerName, contactInfo) {
            document.getElementById('checkinCustomerSearch').value = customerName;
            document.getElementById('checkinSelectedCustomerId').value = customerId;
            document.getElementById('checkinCustomerContact').value = contactInfo;
            document.getElementById('checkinCustomerSuggestions').style.display = 'none';
        }

        function selectNewCheckinCustomer(customerName) {
            document.getElementById('checkinCustomerSearch').value = customerName;
            document.getElementById('checkinSelectedCustomerId').value = 'new';
            document.getElementById('checkinCustomerContact').value = '';
            document.getElementById('checkinCustomerSuggestions').style.display = 'none';
            document.getElementById('checkinCustomerContact').focus();
        }

        // Billing Functions with Contact Management and Duplicate Prevention
        function addItemToTableOrder() {
            const tableId = document.getElementById('billTableSelect').value;
            const customerName = document.getElementById('customerSearchInput').value.trim();
            const customerId = document.getElementById('selectedCustomerId').value;
            const customerContact = document.getElementById('customerContactInput').value.trim();
            const dishName = document.getElementById('dishSearchInput').value.trim();
            const dishPriceRaw = document.getElementById('dishPriceInput').value.trim();
            const quantity = parseInt(document.getElementById('billQuantity').value) || 1;

            if (!tableId) {
                showNotification('Please select a table or room first', 'error');
                return;
            }
            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            if (!dishName) {
                showNotification('Please enter a dish name', 'error');
                return;
            }
            if (!dishPriceRaw || isNaN(dishPriceRaw) || Number(dishPriceRaw) <= 0) {
                showNotification('Please enter a valid price for the dish', 'error');
                return;
            }

            const dishPrice = Number(dishPriceRaw);

            let dishId = null;
            if (selectedDishData && selectedDishData.name.toLowerCase() === dishName.toLowerCase()) {
                dishId = selectedDishData.id;
                if (selectedDishData.price !== dishPrice) {
                    RestaurantDB.menu.update(dishId, { price: dishPrice });
                    showNotification(`Updated price for "${dishName}" to ₹${dishPrice.toFixed(2)}`, 'success');
                }
            } else {
                const newDishData = { 
                    name: dishName, 
                    price: dishPrice, 
                    category: 'Billing Added',
                    description: 'Added from billing software'
                };
                dishId = RestaurantDB.menu.save(newDishData);
                showNotification(`Added new dish "${dishName}" with price ₹${dishPrice.toFixed(2)}`, 'success');
            }

            let finalCustomerId = customerId;
            let finalCustomerName = customerName;
            
            if (!finalCustomerId || finalCustomerId === 'new') {
                finalCustomerId = RestaurantDB.customers.save({ 
                    name: customerName, 
                    phone: customerContact, 
                    email: '', 
                    address: '' 
                });
                
                const customers = RestaurantDB.customers.getAll();
                const customerExists = customers.find(c => 
                    c.name.toLowerCase() === customerName.toLowerCase() && 
                    c.phone === customerContact
                );
                
                if (!customerExists || finalCustomerId !== customerId) {
                    showNotification(`Customer "${customerName}" saved with contact ${customerContact}`, 'success');
                }
            } else {
                const customers = RestaurantDB.customers.getAll();
                const existingCustomer = customers.find(c => c.id == finalCustomerId);
                if (existingCustomer && customerContact && existingCustomer.phone !== customerContact) {
                    RestaurantDB.customers.update(finalCustomerId, { phone: customerContact });
                    showNotification(`Updated contact for "${customerName}" to ${customerContact}`, 'success');
                }
            }

            const success = RestaurantDB.tables.addItemToOrder(tableId, {
                menuId: dishId,
                name: dishName,
                price: dishPrice,
                quantity: quantity
            }, {
                customerId: finalCustomerId,
                customerName: finalCustomerName
            });

            if (success) {
                showNotification(`Added ${quantity} x "${dishName}" to order`, 'success');
                
                document.getElementById('dishSearchInput').value = '';
                document.getElementById('dishPriceInput').value = '';
                document.getElementById('billQuantity').value = 1;
                selectedDishData = null;

                document.getElementById('selectedCustomerId').value = finalCustomerId;

                document.getElementById('simplifiedActions').style.display = 'flex';
                document.getElementById('expandedActions').style.display = 'flex';
                document.getElementById('expandedActions').style.marginTop = '1rem';

                if (currentTab === 'tables') loadTables();
                if (currentTab === 'rooms') loadRooms();
                loadActiveOrders();
                updateContextStats(currentTab);
            } else {
                showNotification('Failed to add item. Check if room is checked in.', 'error');
            }
        }

        function showNewBillForm() {
            document.getElementById('billForm').style.display = 'block';
            document.getElementById('customerDetailsSection').style.display = 'none';
            loadBillingDropdowns();
            setupCustomerSearch();
            setupDishSearch();
            
            document.getElementById('simplifiedActions').style.display = 'flex';
            document.getElementById('expandedActions').style.display = 'none';
        }

        function hideBillForm() {
            document.getElementById('billForm').style.display = 'none';
            document.getElementById('customerDetailsSection').style.display = 'none';
            clearBillForm();
        }

        function clearBillForm() {
            document.getElementById('billTableSelect').value = '';
            document.getElementById('customerSearchInput').value = '';
            document.getElementById('selectedCustomerId').value = '';
            document.getElementById('customerContactInput').value = '';
            document.getElementById('dishSearchInput').value = '';
            document.getElementById('dishPriceInput').value = '';
            document.getElementById('billQuantity').value = '1';
            document.getElementById('customerSuggestions').style.display = 'none';
            document.getElementById('dishSuggestions').style.display = 'none';
            selectedCustomerData = null;
            selectedDishData = null;
            
            document.getElementById('simplifiedActions').style.display = 'flex';
            document.getElementById('expandedActions').style.display = 'none';
        }

        function loadBillingDropdowns() {
            const tables = RestaurantDB.tables.getTables();
            const rooms = RestaurantDB.tables.getRooms().filter(room => room.checkedIn);
            const select = document.getElementById('billTableSelect');
            
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Table/Room FIRST</option>';
            
            tables.forEach(table => {
                const statusText = table.status === 'occupied' ? ' (OCCUPIED)' : ' (AVAILABLE)';
                const itemCount = table.order.items.length > 0 ? ` - ${table.order.items.length} items` : '';
                select.innerHTML += `<option value="${table.id}">Table ${table.number}${statusText}${itemCount}</option>`;
            });
            
            rooms.forEach(room => {
                const itemCount = room.order.items.length > 0 ? ` - ${room.order.items.length} items` : '';
                select.innerHTML += `<option value="${room.id}">Room ${room.number} - CHECKED IN${itemCount}</option>`;
            });
        }

        function loadCustomerForTable() {
            const tableId = document.getElementById('billTableSelect').value;
            const searchInput = document.getElementById('customerSearchInput');
            const contactInput = document.getElementById('customerContactInput');
            const customerDetailsSection = document.getElementById('customerDetailsSection');
            
            if (!tableId) {
                searchInput.value = '';
                contactInput.value = '';
                document.getElementById('selectedCustomerId').value = '';
                customerDetailsSection.style.display = 'none';
                toggleBillFormActions();
                return;
            }

            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id == tableId);
            
            searchInput.placeholder = 'Type customer name to search...';

            if (table && table.status === 'occupied' && table.order.customerName) {
                searchInput.value = table.order.customerName;
                document.getElementById('selectedCustomerId').value = table.order.customerId;
                
                const customers = RestaurantDB.customers.getAll();
                const customer = customers.find(c => c.id == table.order.customerId);
                if (customer) {
                    contactInput.value = customer.phone || customer.email || '';
                }
                
                selectedCustomerData = {
                    id: table.order.customerId,
                    name: table.order.customerName,
                    contact: contactInput.value
                };

                showCustomerDetails(table.order.customerId, table.order.customerName, contactInput.value);
            } else {
                customerDetailsSection.style.display = 'none';
            }
            
            toggleBillFormActions();
        }

        function toggleBillFormActions() {
            const simplifiedActions = document.getElementById('simplifiedActions');
            const expandedActions = document.getElementById('expandedActions');
            
            simplifiedActions.style.display = 'flex';
            
            const tableId = document.getElementById('billTableSelect').value;
            if (tableId) {
                const tables = RestaurantDB.tables.getAll();
                const table = tables.find(t => t.id == tableId);
                
                if (table && table.order.items.length > 0) {
                    expandedActions.style.display = 'flex';
                    expandedActions.style.marginTop = '1rem';
                } else {
                    expandedActions.style.display = 'none';
                }
            } else {
                expandedActions.style.display = 'none';
            }
        }

        function generateBillFromForm() {
            const tableId = document.getElementById('billTableSelect').value;
            
            if (!tableId) {
                showNotification('Please select a table first', 'error');
                return;
            }

            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id == tableId);
            
            if (!table || table.order.items.length === 0) {
                showNotification('Please add items to the order first', 'error');
                return;
            }

            generateBillFromTableData(table);
        }

        function deleteOrderWithoutBill() {
            const tableId = document.getElementById('billTableSelect').value;
            
            if (!tableId) {
                showNotification('Please select a table first', 'error');
                return;
            }

            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id == tableId);
            
            if (!table || table.order.items.length === 0) {
                showNotification('No order to cancel', 'error');
                return;
            }

            if (confirm(`Cancel order for ${table.type} ${table.number}? This will remove all items without generating a bill.`)) {
                RestaurantDB.tables.clearOrder(tableId, true);
                showNotification('Order cancelled successfully without generating bill!');
                hideBillForm();
                if (currentTab === 'tables') loadTables();
                if (currentTab === 'rooms') loadRooms();
                loadActiveOrders();
                updateContextStats(currentTab);
            }
        }

        function generateBillFromTableData(table) {
            let finalTotal = table.order.total;
            let roomCharge = 0;
            
            if (table.type === 'Room' && table.price > 0) {
                roomCharge = table.price;
                finalTotal += roomCharge;
            }

            const bill = RestaurantDB.bills.save({
                tableId: table.id,
                tableNumber: `${table.type} ${table.number}`,
                customerId: table.order.customerId,
                customerName: table.order.customerName,
                customerPhone: getCustomerPhone(table.order.customerId),
                customerEmail: getCustomerEmail(table.order.customerId),
                items: table.order.items,
                roomCharge: roomCharge,
                itemsTotal: table.order.total,
                total: finalTotal
            });

            if (table.order.customerId) {
                RestaurantDB.customers.updateSpent(table.order.customerId, finalTotal);
            }

            if (table.type === 'Room' && table.checkedIn) {
                const result = RestaurantDB.tables.checkOut(table.id, false);
                if (result.success) {
                    showNotification(`Bill generated & Room ${table.number} automatically checked-out!`);
                }
            } else {
                RestaurantDB.tables.clearOrder(table.id, false);
                showNotification('Bill generated successfully!');
            }

            displayBill(bill, table);
            hideBillForm();
            if (currentTab === 'tables') loadTables();
            if (currentTab === 'rooms') loadRooms();
            loadActiveOrders();
            loadBillingDropdowns();
            updateContextStats(currentTab);
        }

        function getCustomerPhone(customerId) {
            if (!customerId) return '';
            const customers = RestaurantDB.customers.getAll();
            const customer = customers.find(c => c.id == customerId);
            return customer ? customer.phone : '';
        }

        function getCustomerEmail(customerId) {
            if (!customerId) return '';
            const customers = RestaurantDB.customers.getAll();
            const customer = customers.find(c => c.id == customerId);
            return customer ? customer.email : '';
        }

        function displayBill(bill, table) {
            const billDisplay = document.getElementById('billDisplay');
            
            billDisplay.innerHTML = `
                <div class="bill-header">
                    <h2>THYNK POS</h2>
                    <p>Bill #${bill.id.toString().slice(-6)}</p>
                    <p>${new Date(bill.date).toLocaleString()}</p>
                </div>
                
                <div>
                    <p><strong>Customer:</strong> ${bill.customerName}</p>
                    <p><strong>Table:</strong> ${bill.tableNumber}</p>
                    ${bill.customerPhone ? `<p><strong>Phone:</strong> ${bill.customerPhone}</p>` : ''}
                </div>
                
                <div class="bill-items">
                    ${bill.items.map(item => `
                        <div class="bill-item">
                            <span>${item.name} x${item.quantity}</span>
                            <span>₹${item.total.toFixed(2)}</span>
                        </div>
                    `).join('')}
                    ${bill.roomCharge > 0 ? `
                        <div class="bill-room-charge">
                            <span>${table.type} Charge (₹${bill.roomCharge}/night)</span>
                            <span>₹${bill.roomCharge.toFixed(2)}</span>
                        </div>
                    ` : ''}
                </div>
                
                ${bill.roomCharge > 0 ? `
                    <div style="margin: 1rem 0; padding: 0.75rem; background: var(--light); border-radius: 8px; border-left: 4px solid var(--info);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Items Subtotal:</span>
                            <span>₹${bill.itemsTotal.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 600; color: var(--warning);">
                            <span>${table.type} Charge:</span>
                            <span>₹${bill.roomCharge.toFixed(2)}</span>
                        </div>
                    </div>
                ` : ''}
                
                <div class="bill-total">
                    Total: ₹${bill.total.toFixed(2)}
                </div>
                
                ${table.type === 'Room' ? `
                    <div style="margin: 1rem 0; padding: 1rem; background: linear-gradient(135deg, var(--success), #059669); color: white; border-radius: 8px; text-align: center; font-weight: 600;">
                        ✅ Room ${table.number} Automatically Checked-Out
                    </div>
                ` : ''}
                
                <div class="bill-actions">
                    <button class="btn btn-sm btn-primary" onclick="printBill(${bill.id})">
                        <span class="material-icons-outlined">print</span>
                        Print
                    </button>
                    
                    ${bill.customerPhone ? `
                        <button class="btn btn-sm whatsapp-btn" onclick="shareOnWhatsApp(${bill.id})">
                            <span class="material-icons-outlined">chat</span>
                            WhatsApp
                        </button>
                    ` : ''}
                    
                    ${bill.customerEmail ? `
                        <button class="btn btn-sm email-btn" onclick="shareViaEmail(${bill.id})">
                            <span class="material-icons-outlined">email</span>
                            Email
                        </button>
                    ` : ''}
                    
                    <button class="btn btn-sm btn-success" onclick="shareBill(${bill.id})">
                        <span class="material-icons-outlined">share</span>
                        Share
                    </button>
                    
                    <button class="btn btn-sm btn-info" onclick="downloadBillImage(${bill.id})">
                        <span class="material-icons-outlined">download</span>
                        Download
                    </button>
                    
                    <button class="btn btn-sm btn-danger" onclick="deleteBill(${bill.id})">
                        <span class="material-icons-outlined">delete</span>
                        Delete
                    </button>
                    
                    <button class="btn btn-sm btn-warning" onclick="closeBillModal()">
                        <span class="material-icons-outlined">close</span>
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('billModal').classList.add('show');
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('show');
        }

        function loadActiveOrders() {
            const tables = RestaurantDB.tables.getAll().filter(t => t.status === 'occupied' && t.order.items.length > 0);
            const container = document.getElementById('activeOrders');
            
            if (tables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🛒</div>
                        <h3>No Active Orders</h3>
                        <p>Add items to tables to see active orders here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tables.map(table => `
                <div class="card">
                    <h3>${table.type} ${table.number} - ${table.order.customerName}</h3>
                    ${table.type === 'Room' ? `<p><small>${table.checkedIn ? '✅ Checked In' : '🔒 Not Checked In'}</small></p>` : ''}
                    <div style="max-height: 150px; overflow-y: auto; margin: 1rem 0;">
                        ${table.order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--light);">
                                <span>${item.name} x${item.quantity}</span>
                                <span>₹${item.total.toFixed(2)}</span>
                            </div>
                        `).join('')}
                        ${table.type === 'Room' && table.price > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); background: rgba(245, 158, 11, 0.1); border-radius: 4px; margin: 0.25rem 0; padding-left: 0.5rem; padding-right: 0.5rem; font-weight: 600; color: var(--warning);">
                                <span>Room Charge</span>
                                <span>₹${table.price.toFixed(2)}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--success); color: white; border-radius: 8px; text-align: center; font-weight: 600;">
                        Total (${table.type === 'Room' && table.price > 0 ? 'with room charge' : 'items only'}): ₹${(table.order.total + (table.type === 'Room' ? table.price : 0)).toFixed(2)}
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-success" onclick="generateBillFromTableData(${JSON.stringify(table).replace(/"/g, '&quot;')})">
                            <span class="material-icons-outlined">receipt</span>
                            Generate Bill
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="cancelOrderFromActive(${table.id})">
                            <span class="material-icons-outlined">cancel</span>
                            Cancel Order
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function cancelOrderFromActive(tableId) {
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            
            if (!table) return;

            if (confirm(`Cancel order for ${table.type} ${table.number}? All items will be removed without generating a bill.`)) {
                RestaurantDB.tables.clearOrder(tableId, true);
                showNotification('Order cancelled successfully without generating bill!');
                if (currentTab === 'tables') loadTables();
                if (currentTab === 'rooms') loadRooms();
                loadActiveOrders();
                updateContextStats(currentTab);
            }
        }

        // NEW: Bills History Functions
        function showBillsHistory() {
            const bills = RestaurantDB.bills.getAll().sort((a, b) => new Date(b.date) - new Date(a.date));
            const container = document.getElementById('billsHistoryContent');
            
            if (bills.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <h3>No Bills Generated Yet</h3>
                        <p>Bills will appear here once you generate them</p>
                    </div>
                `;
            } else {
                container.innerHTML = bills.map(bill => {
                    const searchData = `${bill.customerName} ${bill.tableNumber} ${bill.id} ${new Date(bill.date).toLocaleDateString()}`;
                    return `
                        <div class="card" data-bill-id="${bill.id}" data-bill-search="${searchData}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Bill #${bill.id.toString().slice(-6)}</h3>
                                <span style="font-weight: 600; color: var(--primary);">₹${bill.total.toFixed(2)}</span>
                            </div>
                            <p><strong>Customer:</strong> ${bill.customerName}</p>
                            <p><strong>Table/Room:</strong> ${bill.tableNumber}</p>
                            <p><strong>Date:</strong> ${new Date(bill.date).toLocaleString()}</p>
                            <p><strong>Items:</strong> ${bill.items.length} items</p>
                            ${bill.roomCharge > 0 ? `<p><strong>Room Charge:</strong> ₹${bill.roomCharge.toFixed(2)}</p>` : ''}
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-primary" onclick="viewBillDetails(${bill.id})">
                                    <span class="material-icons-outlined">visibility</span>
                                    View
                                </button>
                                <button class="btn btn-sm btn-success" onclick="printBill(${bill.id})">
                                    <span class="material-icons-outlined">print</span>
                                    Print
                                </button>
                                ${bill.customerPhone ? `
                                    <button class="btn btn-sm whatsapp-btn" onclick="shareOnWhatsApp(${bill.id})">
                                        <span class="material-icons-outlined">chat</span>
                                        WhatsApp
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-info" onclick="shareBill(${bill.id})">
                                    <span class="material-icons-outlined">share</span>
                                    Share
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteBill(${bill.id})" title="Delete Bill">
                                    <span class="material-icons-outlined">delete</span>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('billsHistoryModal').classList.add('show');
        }

        function closeBillsHistoryModal() {
            document.getElementById('billsHistoryModal').classList.remove('show');
        }

        function viewBillDetails(billId) {
            const bills = RestaurantDB.bills.getAll();
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            // Create a mock table object for display purposes
            const mockTable = {
                type: bill.tableNumber.includes('Room') ? 'Room' : 'Table',
                number: bill.tableNumber.replace(/[^\d]/g, '')
            };

            displayBill(bill, mockTable);
            closeBillsHistoryModal();
        }

        // ENHANCED: Table/Room Management Functions
        function addNewTable(type = null) {
            editingTableId = null;
            selectedTableType = type;
            document.getElementById('modalTitle').textContent = type ? `Add New ${type}` : 'Add New Table/Room';
            
            if (type) {
                // Skip type selector if type is specified
                document.getElementById('typeSelector').style.display = 'none';
                document.getElementById('tableFormSection').style.display = 'block';
                document.getElementById('typeSelectorTitle').textContent = `Adding ${type}`;
                document.getElementById('typeButtons').style.display = 'none';
                toggleFieldsForType(type);
            } else {
                document.getElementById('typeSelector').style.display = 'block';
                document.getElementById('tableFormSection').style.display = 'none';
                document.getElementById('typeSelectorTitle').textContent = 'First, Select Type';
                document.getElementById('typeButtons').style.display = 'grid';
                document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            }
            
            document.getElementById('tableNumber').value = '';
            document.getElementById('tableChairs').value = '4';
            document.getElementById('roomPrice').value = '';
            
            document.getElementById('tableModal').classList.add('show');
        }

        function editTable(tableId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            if (!table) return;

            editingTableId = tableId;
            selectedTableType = table.type;
            document.getElementById('modalTitle').textContent = `Edit ${table.type} ${table.number}`;
            
            document.getElementById('typeSelector').style.display = 'none';
            document.getElementById('tableFormSection').style.display = 'block';
            
            document.getElementById('tableNumber').value = table.number;
            document.getElementById('tableChairs').value = table.chairs || 4;
            document.getElementById('roomPrice').value = table.price || 0;
            
            toggleFieldsForType(table.type);
            
            document.getElementById('tableModal').classList.add('show');
        }

        function selectTableType(type) {
            selectedTableType = type;
            
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(type.toLowerCase() + 'TypeBtn').classList.add('active');
            
            document.getElementById('typeSelector').style.display = 'none';
            document.getElementById('tableFormSection').style.display = 'block';
            
            document.querySelectorAll('#tableFormGrid .form-input').forEach(input => {
                input.className = 'form-input big';
            });
            
            toggleFieldsForType(type);
            
            const numberInput = document.getElementById('tableNumber');
            numberInput.placeholder = `${type} Number`;
            numberInput.focus();
        }

        function toggleFieldsForType(type) {
            const chairsGroup = document.getElementById('chairsGroup');
            const priceGroup = document.getElementById('priceGroup');
            
            if (type === 'Room') {
                chairsGroup.style.display = 'none';
                priceGroup.style.display = 'block';
            } else {
                chairsGroup.style.display = 'block';
                priceGroup.style.display = 'none';
            }
        }

        function goBackToTypeSelection() {
            document.getElementById('typeSelector').style.display = 'block';
            document.getElementById('tableFormSection').style.display = 'none';
            document.getElementById('typeSelectorTitle').textContent = 'First, Select Type';
            document.getElementById('typeButtons').style.display = 'grid';
            selectedTableType = null;
        }

        function saveTable() {
            if (!selectedTableType) {
                showNotification('Please select table or room type first', 'error');
                return;
            }

            const number = document.getElementById('tableNumber').value.trim();
            const chairs = selectedTableType === 'Table' ? document.getElementById('tableChairs').value.trim() : 0;
            const price = selectedTableType === 'Room' ? document.getElementById('roomPrice').value.trim() : 0;

            if (!number) {
                showNotification(`Please enter ${selectedTableType.toLowerCase()} number`, 'error');
                return;
            }

            if (selectedTableType === 'Table' && !chairs) {
                showNotification('Please enter number of chairs', 'error');
                return;
            }

            if (selectedTableType === 'Room' && !price) {
                showNotification('Please enter room price per night', 'error');
                return;
            }

            if (editingTableId) {
                RestaurantDB.tables.update(editingTableId, { 
                    number: parseInt(number), 
                    type: selectedTableType, 
                    chairs: parseInt(chairs) || 0,
                    price: parseFloat(price) || 0
                });
                showNotification(`${selectedTableType} ${number} updated successfully!`);
            } else {
                const result = RestaurantDB.tables.save({ 
                    number: parseInt(number), 
                    type: selectedTableType, 
                    chairs: parseInt(chairs) || 0,
                    price: parseFloat(price) || 0
                });
                if (result) {
                    showNotification(`${selectedTableType} ${number} added successfully!`);
                }
            }

            closeTableModal();
            if (currentTab === 'tables') loadTables();
            if (currentTab === 'rooms') loadRooms();
            updateContextStats(currentTab);
        }

        function closeTableModal() {
            document.getElementById('tableModal').classList.remove('show');
            selectedTableType = null;
            editingTableId = null;
        }

        function deleteTable(id, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === id);
            if (!table) return;

            if (confirm(`Delete ${table.type} ${table.number}? This cannot be undone.`)) {
                RestaurantDB.tables.delete(id);
                showNotification(`${table.type} ${table.number} deleted successfully`);
                if (currentTab === 'tables') loadTables();
                if (currentTab === 'rooms') loadRooms();
                updateContextStats(currentTab);
            }
        }

        // Load Tables Function
        function loadTables() {
            const tables = RestaurantDB.tables.getTables();
            const container = document.getElementById('tablesGrid');
            document.getElementById('tableCount').textContent = tables.length;
            
            if (tables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🍽️</div>
                        <h3>No Tables Added Yet</h3>
                        <p>Click "Add Table" to create restaurant tables</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tables.map(table => renderTableTile(table)).join('');

            const searchQuery = document.getElementById('tableSearchInput').value;
            if (searchQuery) {
                filterTables();
            }
        }

        // Load Rooms Function
        function loadRooms() {
            const rooms = RestaurantDB.tables.getRooms();
            const container = document.getElementById('roomsGrid');
            document.getElementById('roomCount').textContent = rooms.length;
            
            if (rooms.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🏨</div>
                        <h3>No Rooms Added Yet</h3>
                        <p>Click "Add Room" to create hotel rooms</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rooms.map(room => renderTableTile(room)).join('');

            const searchQuery = document.getElementById('roomSearchInput').value;
            if (searchQuery) {
                filterRooms();
            }
        }

        function renderTableTile(table) {
            const isExpanded = expandedTileId === table.id;
            const orderItems = table.order.items || [];
            const customerName = table.order.customerName || 'No customer';
            const typeClass = table.type.toLowerCase();
            const statusClass = table.status;
            
            let actionCount = 2; // Always has "Edit" and one more action
            if (table.type === 'Room' && table.checkedIn) actionCount += 2; // Check-out, Cancel Check-in
            if (orderItems.length > 0) actionCount += 2; // Generate Bill, Cancel Order
            
            return `
                <div class="table-tile ${typeClass} ${statusClass} ${isExpanded ? 'expanded' : ''}" onclick="toggleTileDetails(${table.id})" id="tile-${table.id}">
                    <button class="tile-remove-btn" onclick="deleteTable(${table.id}, event)" title="Remove ${table.type} ${table.number}">
                        <span class="material-icons-outlined" style="font-size: 14px;">close</span>
                    </button>
                    
                    <div class="tile-header">
                        <div class="tile-number">${table.type === 'Room' ? 'R' : 'T'}${table.number}</div>
                        <div class="tile-info">${table.type} ${table.status === 'available' ? '(Available)' : '(Occupied)'}</div>
                        <div class="tile-price">
                            ${table.type === 'Room' ? 
                                `₹${table.price}/night` : 
                                `${table.chairs} ${table.chairs === 1 ? 'Chair' : 'Chairs'}`
                            }
                        </div>
                        ${table.type === 'Room' ? `
                            <div class="checkin-status">
                                ${table.checkedIn ? '✅ Checked In' : '🔒 Not Checked In'}
                            </div>
                        ` : ''}
                        ${orderItems.length > 0 ? `<div class="tile-price" style="font-weight: 800;">₹${table.order.total.toFixed(2)}</div>` : ''}
                    </div>

                    <div class="tile-details ${isExpanded ? 'expanded' : ''}" style="max-height: ${isExpanded ? (200 + (actionCount * 50)) : 0}px;">
                        <div class="details-content">
                            <div class="customer-info">
                                <strong>Customer:</strong> ${customerName}
                                ${table.type === 'Room' && table.checkedIn ? `<br><small>Checked in: ${new Date(table.checkInDate).toLocaleString()}</small>` : ''}
                            </div>
                            
                            ${orderItems.length > 0 ? `
                                <div class="menu-items">
                                    ${orderItems.map(item => `
                                        <div class="menu-item">
                                            <span>${item.name} x${item.quantity}</span>
                                            <span>₹${item.total.toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="text-align: center; color: var(--dark); opacity: 0.8; margin: 1rem 0;">No items added yet</div>'}
                            
                            <div class="tile-actions">
                                <button class="btn btn-sm btn-warning" onclick="editTable(${table.id}, event)" title="Edit ${table.type}">
                                    <span class="material-icons-outlined">edit</span>
                                    Edit
                                </button>
                                
                                ${table.type === 'Room' && !table.checkedIn ? `
                                    <button class="btn btn-sm btn-info" onclick="showCheckinModal(${table.id}, event)">
                                        <span class="material-icons-outlined">login</span>
                                        Check-in
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-primary" onclick="addItemToTableFromTile(${table.id}, event)">
                                        <span class="material-icons-outlined">add</span>
                                        Add Item
                                    </button>
                                `}
                                
                                ${table.type === 'Room' && table.checkedIn ? `
                                    <button class="btn btn-sm btn-warning" onclick="performRoomCheckout(${table.id}, event)">
                                        <span class="material-icons-outlined">logout</span>
                                        Check-out
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelRoomCheckin(${table.id}, event)">
                                        <span class="material-icons-outlined">cancel</span>
                                        Cancel Check-in
                                    </button>
                                ` : ''}
                                
                                ${orderItems.length > 0 ? `
                                    <button class="btn btn-sm btn-success" onclick="generateBillFromTableInTile(${table.id}, event)">
                                        <span class="material-icons-outlined">receipt</span>
                                        Generate Bill
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelOrderFromTile(${table.id}, event)">
                                        <span class="material-icons-outlined">cancel</span>
                                        Cancel Order
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleTileDetails(tableId) {
            if (expandedTileId === tableId) {
                expandedTileId = null;
            } else {
                expandedTileId = tableId;
            }
            if (currentTab === 'tables') loadTables();
            if (currentTab === 'rooms') loadRooms();
        }

        // INTEGRATED: Room Check-in Modal Functions
        function showCheckinModal(roomId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const rooms = RestaurantDB.tables.getRooms();
            const room = rooms.find(r => r.id === roomId);
            if (!room) return;
            
            selectedRoomForCheckin = roomId;
            document.getElementById('checkinRoomInfo').textContent = `Room ${room.number} - ₹${room.price}/night`;
            document.getElementById('checkinCustomerSearch').value = '';
            document.getElementById('checkinSelectedCustomerId').value = '';
            document.getElementById('checkinCustomerContact').value = '';
            document.getElementById('checkinCustomerSuggestions').style.display = 'none';
            
            document.getElementById('checkinModal').classList.add('show');
            setupCheckinCustomerSearch();
            document.getElementById('checkinCustomerSearch').focus();
        }

        function closeCheckinModal() {
            document.getElementById('checkinModal').classList.remove('show');
            selectedRoomForCheckin = null;
        }

        function performRoomCheckinFromModal() {
            let customerId = document.getElementById('checkinSelectedCustomerId').value;
            let customerName = document.getElementById('checkinCustomerSearch').value.trim();
            let customerContact = document.getElementById('checkinCustomerContact').value.trim();

            if (!customerName) {
                showNotification('Please enter customer name for check-in', 'error');
                return;
            }

            let finalCustomerName = customerName;
            let finalCustomerId = customerId;

            if (!customerId || customerId === 'new') {
                finalCustomerId = RestaurantDB.customers.save({ 
                    name: customerName, 
                    phone: customerContact, 
                    email: '', 
                    address: '' 
                });
                finalCustomerName = customerName;
            } else if (customerContact) {
                RestaurantDB.customers.update(finalCustomerId, { phone: customerContact });
            }

            const success = RestaurantDB.tables.checkIn(selectedRoomForCheckin, {
                customerId: finalCustomerId,
                customerName: finalCustomerName
            });

            if (success) {
                const rooms = RestaurantDB.tables.getRooms();
                const room = rooms.find(r => r.id === selectedRoomForCheckin);
                showNotification(`Room ${room.number} checked-in successfully for ${finalCustomerName}!`);
                closeCheckinModal();
                loadRooms();
                loadBillingDropdowns();
                updateContextStats('rooms');
            } else {
                showNotification('Failed to check-in room', 'error');
            }
        }

        function addItemToTableFromTile(tableId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            
            if (table && table.type === 'Room' && !table.checkedIn) {
                showNotification('Please check-in to the room first before adding items', 'error');
                return;
            }
            
            switchTab('billing');
            setTimeout(() => {
                showNewBillForm();
                document.getElementById('billTableSelect').value = tableId;
                loadCustomerForTable();
            }, 300);
        }

        function generateBillFromTableInTile(tableId, event) {
            event.stopPropagation();
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            
            if (!table || table.order.items.length === 0) {
                showNotification('No items in order to bill', 'error');
                return;
            }

            generateBillFromTableData(table);
        }

        function cancelOrderFromTile(tableId, event) {
            event.stopPropagation();
            
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            
            if (!table) return;

            if (confirm(`Cancel order for ${table.type} ${table.number}? All items will be removed.`)) {
                RestaurantDB.tables.clearOrder(tableId, true);
                showNotification('Order cancelled successfully!');
                if (currentTab === 'tables') loadTables();
                if (currentTab === 'rooms') loadRooms();
                loadActiveOrders();
                updateContextStats(currentTab);
            }
        }

        // ENHANCED: Room Checkout with Automatic Bill Generation
        function performRoomCheckout(tableId, event) {
            event.stopPropagation();
            
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            
            if (!table) return;

            // Always generate bill on checkout (even without items for room charge)
            const result = RestaurantDB.tables.checkOut(tableId, true);
            
            if (result.success) {
                showNotification(`Room ${table.number} checked-out successfully!`);
                
                if (result.bill) {
                    displayCheckoutBill(result.bill, result.table);
                }
                
                loadRooms();
                loadActiveOrders();
                loadBillingDropdowns();
                updateContextStats('rooms');
            } else {
                showNotification('Failed to check-out room', 'error');
            }
        }

        function cancelRoomCheckin(tableId, event) {
            event.stopPropagation();
            
            const tables = RestaurantDB.tables.getAll();
            const table = tables.find(t => t.id === tableId);
            
            if (!table) return;

            if (table.order.items.length > 0) {
                if (!confirm(`Room ${table.number} has pending orders. Cancelling check-in will remove all items. Continue?`)) {
                    return;
                }
            }

            RestaurantDB.tables.update(tableId, {
                checkedIn: false,
                status: 'available',
                checkInDate: null,
                order: {
                    customerId: null,
                    customerName: '',
                    items: [],
                    total: 0
                }
            });

            showNotification(`Room ${table.number} check-in cancelled successfully!`);
            loadRooms();
            loadActiveOrders();
            loadBillingDropdowns();
            updateContextStats('rooms');
        }

        function displayCheckoutBill(bill, table) {
            const checkoutBillContent = document.getElementById('checkoutBillContent');
            
            checkoutBillContent.innerHTML = `
                <div class="bill-display">
                    <div class="bill-header">
                        <h2>THYNK POS - CHECKOUT BILL</h2>
                        <p>Bill #${bill.id.toString().slice(-6)}</p>
                        <p>${new Date(bill.date).toLocaleString()}</p>
                    </div>
                    
                    <div>
                        <p><strong>Customer:</strong> ${bill.customerName}</p>
                        <p><strong>Room:</strong> ${bill.tableNumber}</p>
                        <p><strong>Check-out:</strong> ${new Date().toLocaleString()}</p>
                        ${bill.customerPhone ? `<p><strong>Phone:</strong> ${bill.customerPhone}</p>` : ''}
                    </div>
                    
                    <div class="bill-items">
                        ${bill.items.length > 0 ? bill.items.map(item => `
                            <div class="bill-item">
                                <span>${item.name} x${item.quantity}</span>
                                <span>₹${item.total.toFixed(2)}</span>
                            </div>
                        `).join('') : '<p style="text-align: center; color: var(--text-light);">No items ordered</p>'}
                        ${bill.roomCharge > 0 ? `
                            <div class="bill-room-charge">
                                <span>Room Charge (₹${bill.roomCharge}/night)</span>
                                <span>₹${bill.roomCharge.toFixed(2)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="bill-total">
                        Total: ₹${bill.total.toFixed(2)}
                    </div>
                    
                    <div class="bill-actions">
                        <button class="btn btn-sm btn-primary" onclick="printBill(${bill.id})">
                            <span class="material-icons-outlined">print</span>
                            Print
                        </button>
                        
                        ${bill.customerPhone ? `
                            <button class="btn btn-sm whatsapp-btn" onclick="shareOnWhatsApp(${bill.id})">
                                <span class="material-icons-outlined">chat</span>
                                WhatsApp
                            </button>
                        ` : ''}
                        
                        ${bill.customerEmail ? `
                            <button class="btn btn-sm email-btn" onclick="shareViaEmail(${bill.id})">
                                <span class="material-icons-outlined">email</span>
                                Email
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-sm btn-success" onclick="shareBill(${bill.id})">
                            <span class="material-icons-outlined">share</span>
                            Share
                        </button>
                        
                        <button class="btn btn-sm btn-warning" onclick="closeCheckoutBillModal()">
                            <span class="material-icons-outlined">close</span>
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('checkoutBillModal').classList.add('show');
        }

        function closeCheckoutBillModal() {
            document.getElementById('checkoutBillModal').classList.remove('show');
        }

        // Bill sharing functions
        function shareOnWhatsApp(billId) {
            const bills = RestaurantDB.bills.getAll();
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const billText = `
*THYNK POS - Bill #${bill.id.toString().slice(-6)}*

📅 Date: ${new Date(bill.date).toLocaleString()}
👤 Customer: ${bill.customerName}
🏠 Table: ${bill.tableNumber}

*Items:*
${bill.items.map(item => `• ${item.name} x${item.quantity} = ₹${item.total.toFixed(2)}`).join('\n')}
${bill.roomCharge > 0 ? `\n🏨 Room Charge: ₹${bill.roomCharge.toFixed(2)}` : ''}

*Total: ₹${bill.total.toFixed(2)}*

Thank you for your business! 🙏
_Powered by Thynk POS v1.81 - Free Forever_
            `;

            const phoneNumber = bill.customerPhone.replace(/[^0-9]/g, '');
            const whatsappUrl = `https://wa.me/${phoneNumber.startsWith('91') ? phoneNumber : '91' + phoneNumber}?text=${encodeURIComponent(billText)}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('Opening WhatsApp to send bill...');
        }

        function shareViaEmail(billId) {
            const bills = RestaurantDB.bills.getAll();
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const subject = `Bill #${bill.id.toString().slice(-6)} - Thynk POS`;
            const body = `
Dear ${bill.customerName},

Thank you for your business! Here's your bill:

Bill #: ${bill.id.toString().slice(-6)}
Date: ${new Date(bill.date).toLocaleString()}
Customer: ${bill.customerName}
Table: ${bill.tableNumber}

Items:
${bill.items.map(item => `${item.name} x${item.quantity} = ₹${item.total.toFixed(2)}`).join('\n')}
${bill.roomCharge > 0 ? `\nRoom Charge: ₹${bill.roomCharge.toFixed(2)}` : ''}

Total: ₹${bill.total.toFixed(2)}

Thank you for choosing us!

Best regards,
Your Restaurant Team

Powered by Thynk POS v1.81 - Free Forever
            `;

            const mailtoUrl = `mailto:${bill.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoUrl);
            showNotification('Opening email client to send bill...');
        }

        function deleteBill(billId) {
            if (confirm('Delete this bill? This action cannot be undone and is useful if customer cancels the order.')) {
                const success = RestaurantDB.bills.delete(billId);
                if (success) {
                    showNotification('Bill deleted successfully! Order cancelled.');
                    closeBillModal();
                    closeCheckoutBillModal();
                    closeBillsHistoryModal();
                    updateContextStats(currentTab);
                } else {
                    showNotification('Error deleting bill', 'error');
                }
            }
        }

        function printBill(billId) {
            const bills = RestaurantDB.bills.getAll();
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const printContent = `
                <div style="max-width: 400px; margin: 0 auto; font-family: monospace;">
                    <h2 style="text-align: center;">THYNK POS</h2>
                    <p style="text-align: center;">Hotel Management System</p>
                    <hr>
                    <p><strong>Bill #:</strong> ${bill.id.toString().slice(-6)}</p>
                    <p><strong>Date:</strong> ${new Date(bill.date).toLocaleString()}</p>
                    <p><strong>Customer:</strong> ${bill.customerName}</p>
                    <p><strong>Table:</strong> ${bill.tableNumber}</p>
                    ${bill.customerPhone ? `<p><strong>Phone:</strong> ${bill.customerPhone}</p>` : ''}
                    <hr>
                    ${bill.items.map(item => `
                        <p>${item.name} x${item.quantity} = ₹${item.total.toFixed(2)}</p>
                    `).join('')}
                    ${bill.roomCharge > 0 ? `
                        <hr>
                        <p>Room Charge = ₹${bill.roomCharge.toFixed(2)}</p>
                    ` : ''}
                    <hr>
                    <p style="font-size: 18px;"><strong>Total: ₹${bill.total.toFixed(2)}</strong></p>
                    <hr>
                    <p style="text-align: center;">Thank you for your business!</p>
                    <p style="text-align: center; font-size: 12px; margin-top: 20px;">Powered by Thynk POS v1.81 - Free Forever</p>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.print();
            showNotification('Bill sent to printer!');
        }

        function shareBill(billId) {
            const bills = RestaurantDB.bills.getAll();
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const billText = `
THYNK POS - Bill #${bill.id.toString().slice(-6)}
Date: ${new Date(bill.date).toLocaleString()}
Customer: ${bill.customerName}
Table: ${bill.tableNumber}

Items:
${bill.items.map(item => `${item.name} x${item.quantity} = ₹${item.total.toFixed(2)}`).join('\n')}
${bill.roomCharge > 0 ? `\nRoom Charge: ₹${bill.roomCharge.toFixed(2)}` : ''}

Total: ₹${bill.total.toFixed(2)}

Thank you for your business!
Powered by Thynk POS v1.81 - Free Forever
            `;

            if (navigator.share) {
                navigator.share({
                    title: `Bill #${bill.id.toString().slice(-6)}`,
                    text: billText
                });
            } else {
                navigator.clipboard.writeText(billText);
                showNotification('Bill copied to clipboard!');
            }
        }

        function downloadBillImage(billId) {
            const bills = RestaurantDB.bills.getAll();
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const billData = `data:text/plain;charset=utf-8,${encodeURIComponent(`
THYNK POS - Bill #${bill.id.toString().slice(-6)}
Date: ${new Date(bill.date).toLocaleString()}
Customer: ${bill.customerName}
Table: ${bill.tableNumber}
${bill.customerPhone ? `Phone: ${bill.customerPhone}` : ''}

Items:
${bill.items.map(item => `${item.name} x${item.quantity} = ₹${item.total.toFixed(2)}`).join('\n')}
${bill.roomCharge > 0 ? `\nRoom Charge: ₹${bill.roomCharge.toFixed(2)}` : ''}

Total: ₹${bill.total.toFixed(2)}

Thank you for your business!
Powered by Thynk POS v1.81 - Free Forever
            `)}`;

            const downloadLink = document.createElement('a');
            downloadLink.href = billData;
            downloadLink.download = `bill-${bill.id}.txt`;
            downloadLink.click();
            showNotification('Bill downloaded!');
        }

        // Menu Management Functions
        function showAddMenuForm() {
            document.getElementById('menuForm').style.display = 'block';
            document.getElementById('menuItemName').focus();
        }

        function hideMenuForm() {
            document.getElementById('menuForm').style.display = 'none';
            clearMenuForm();
        }

        function clearMenuForm() {
            document.getElementById('menuItemName').value = '';
            document.getElementById('menuItemPrice').value = '';
            document.getElementById('menuItemCategory').value = '';
            document.getElementById('menuItemDescription').value = '';
        }

        function saveMenuItem() {
            const name = document.getElementById('menuItemName').value.trim();
            const price = document.getElementById('menuItemPrice').value.trim();
            const category = document.getElementById('menuItemCategory').value.trim();
            const description = document.getElementById('menuItemDescription').value.trim();

            if (!name || !price || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (parseFloat(price) <= 0) {
                showNotification('Price must be greater than 0', 'error');
                return;
            }

            RestaurantDB.menu.save({ name, price: parseFloat(price), category, description });
            showNotification(`"${name}" added to menu!`);
            
            hideMenuForm();
            loadMenuItems();
            updateContextStats('menu');
        }

        function loadMenuItems() {
            const menuItems = RestaurantDB.menu.getAll();
            const container = document.getElementById('menuItems');
            
            if (menuItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🍽️</div>
                        <h3>No Menu Items Yet</h3>
                        <p>Add menu items manually or use bulk import</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = menuItems.map(item => `
                <div class="card" data-menu-id="${item.id}">
                    <h3>${item.name}</h3>
                    <p><strong>${item.category}</strong> - <strong>₹${item.price.toFixed(2)}</strong></p>
                    ${item.description ? `<p style="color: var(--text-light); font-size: 0.9rem;">${item.description}</p>` : ''}
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary" onclick="editMenuItem(${item.id})">
                            <span class="material-icons-outlined">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenuItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')">
                            <span class="material-icons-outlined">delete</span>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');

            const searchQuery = document.getElementById('menuSearchInput').value;
            if (searchQuery) {
                filterMenuItems();
            }
        }

        function editMenuItem(id) {
            const menuItems = RestaurantDB.menu.getAll();
            const item = menuItems.find(m => m.id === id);
            if (!item) return;

            document.getElementById('menuItemName').value = item.name;
            document.getElementById('menuItemPrice').value = item.price;
            document.getElementById('menuItemCategory').value = item.category;
            document.getElementById('menuItemDescription').value = item.description || '';
            
            const saveBtn = document.querySelector('#menuForm .btn-success');
            saveBtn.onclick = () => updateMenuItem(id);
            saveBtn.innerHTML = '<span class="material-icons-outlined">update</span> Update Menu Item';
            
            showAddMenuForm();
        }

        function updateMenuItem(id) {
            const name = document.getElementById('menuItemName').value.trim();
            const price = document.getElementById('menuItemPrice').value.trim();
            const category = document.getElementById('menuItemCategory').value.trim();
            const description = document.getElementById('menuItemDescription').value.trim();

            if (!name || !price || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            RestaurantDB.menu.update(id, { name, price: parseFloat(price), category, description });
            showNotification(`"${name}" updated successfully!`);
            
            const saveBtn = document.querySelector('#menuForm .btn-success');
            saveBtn.onclick = saveMenuItem;
            saveBtn.innerHTML = '<span class="material-icons-outlined">save</span> Save Menu Item';
            
            hideMenuForm();
            loadMenuItems();
        }

        function deleteMenuItem(id, name) {
            if (confirm(`Delete "${name}" from menu?`)) {
                RestaurantDB.menu.delete(id);
                showNotification(`"${name}" deleted successfully`);
                loadMenuItems();
                updateContextStats('menu');
            }
        }

        // Template Downloads
        function downloadMenuTemplate() {
            const template = [
                ['Item Name', 'Price', 'Category', 'Description'],
                ['Butter Chicken', '320', 'Main Course', 'Rich and creamy chicken curry'],
                ['Paneer Tikka', '280', 'Starters', 'Grilled cottage cheese with spices'],
                ['Dal Makhani', '220', 'Dal', 'Creamy black lentils'],
                ['Basmati Rice', '180', 'Rice', 'Premium long grain rice'],
                ['Garlic Naan', '80', 'Bread', 'Freshly baked with garlic'],
                ['Fresh Lime Soda', '60', 'Beverages', 'Refreshing lime drink'],
                ['Gulab Jamun', '120', 'Desserts', 'Sweet milk dumplings']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Menu Template');
            
            XLSX.writeFile(wb, 'Thynk_POS_Menu_Template.xlsx');
            showNotification('Menu template downloaded! Fill it and import back.');
        }

        function downloadCustomerTemplate() {
            const template = [
                ['Customer Name', 'Phone Number', 'Email Address', 'Address'],
                ['John Doe', '9876543210', 'john@example.com', '123 Main Street, City'],
                ['Jane Smith', '9876543211', 'jane@example.com', '456 Oak Avenue, City'],
                ['Mike Johnson', '9876543212', 'mike@example.com', '789 Pine Road, City'],
                ['Sarah Wilson', '9876543213', 'sarah@example.com', '321 Elm Street, City']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Customer Template');
            
            XLSX.writeFile(wb, 'Thynk_POS_Customer_Template.xlsx');
            showNotification('Customer template downloaded! Fill it and import back.');
        }

        // Excel Import Functions
        function importMenuFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const menuItems = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1] && row[2]) {
                            menuItems.push({
                                name: row[0],
                                price: parseFloat(row[1]) || 0,
                                category: row[2],
                                description: row[3] || ''
                            });
                        }
                    }
                    
                    if (menuItems.length > 0) {
                        let addedCount = 0;
                        menuItems.forEach(item => {
                            RestaurantDB.menu.save(item);
                            addedCount++;
                        });
                        showNotification(`Successfully imported ${addedCount} menu items!`);
                        loadMenuItems();
                        updateContextStats('menu');
                    } else {
                        showNotification('No valid menu items found in the file', 'error');
                    }
                } catch (error) {
                    showNotification('Error reading Excel file. Please check the format.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function importCustomersFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const customers = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1]) {
                            customers.push({
                                name: row[0],
                                phone: row[1].toString(),
                                email: row[2] || '',
                                address: row[3] || ''
                            });
                        }
                    }
                    
                    if (customers.length > 0) {
                        let addedCount = 0;
                        customers.forEach(customer => {
                            RestaurantDB.customers.save(customer);
                            addedCount++;
                        });
                        showNotification(`Successfully imported ${addedCount} customers!`);
                        loadCustomers();
                        updateContextStats('customers');
                    } else {
                        showNotification('No valid customers found in the file', 'error');
                    }
                } catch (error) {
                    showNotification('Error reading Excel file. Please check the format.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // Customer Management Functions
        function showAddCustomerForm() {
            editingCustomerId = null;
            document.getElementById('customerFormTitle').textContent = 'Add New Customer';
            document.getElementById('customerForm').style.display = 'block';
            document.getElementById('customerName').focus();
        }

        function hideCustomerForm() {
            document.getElementById('customerForm').style.display = 'none';
            clearCustomerForm();
            editingCustomerId = null;
        }

        function clearCustomerForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
        }

        function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const address = document.getElementById('customerAddress').value.trim();

            if (!name || !phone) {
                showNotification('Please fill in name and phone number', 'error');
                return;
            }

            if (editingCustomerId) {
                RestaurantDB.customers.update(editingCustomerId, { name, phone, email, address });
                showNotification(`Customer "${name}" updated successfully!`);
            } else {
                RestaurantDB.customers.save({ name, phone, email, address });
                showNotification(`Customer "${name}" added successfully!`);
            }

            hideCustomerForm();
            loadCustomers();
            updateContextStats('customers');
        }

        function editCustomer(id) {
            const customers = RestaurantDB.customers.getAll();
            const customer = customers.find(c => c.id === id);
            if (!customer) return;

            editingCustomerId = id;
            document.getElementById('customerFormTitle').textContent = 'Edit Customer';
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerAddress').value = customer.address;
            document.getElementById('customerForm').style.display = 'block';
        }

        function deleteCustomer(id, name) {
            if (confirm(`Delete customer "${name}"? This cannot be undone.`)) {
                const success = RestaurantDB.customers.delete(id);
                if (success) {
                    showNotification(`Customer "${name}" deleted successfully!`);
                    loadCustomers();
                    updateContextStats('customers');
                } else {
                    showNotification('Error deleting customer', 'error');
                }
            }
        }

        // ENHANCED: Customer with Order History
        function loadCustomers() {
            const customers = RestaurantDB.customers.getAll();
            const container = document.getElementById('customersList');
            
            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <h3>No Customers Added Yet</h3>
                        <p>Add customers manually or use bulk import</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = customers.map(customer => `
                <div class="card" data-customer-id="${customer.id}" onclick="showCustomerHistory(${customer.id})">
                    <h3>${customer.name}</h3>
                    <p><strong>Phone:</strong> ${customer.phone}</p>
                    <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                    <p><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                    <p><strong>Total Orders:</strong> ${customer.totalOrders}</p>
                    <p><strong>Total Spent:</strong> ₹${customer.totalSpent.toFixed(2)}</p>
                    ${customer.lastVisit ? `<p><strong>Last Visit:</strong> ${new Date(customer.lastVisit).toLocaleDateString()}</p>` : ''}
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;" onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-primary" onclick="editCustomer(${customer.id})">
                            <span class="material-icons-outlined">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-success" onclick="createBillForCustomer(${customer.id})">
                            <span class="material-icons-outlined">receipt</span>
                            Create Bill
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}')">
                            <span class="material-icons-outlined">delete</span>
                            Delete
                        </button>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center; font-size: 0.85rem; color: var(--primary); font-weight: 600;">
                        Click card to view complete order history
                    </div>
                </div>
            `).join('');

            const searchQuery = document.getElementById('customerSearchFilter').value;
            if (searchQuery) {
                filterCustomers();
            }
        }

        // ENHANCED: Customer Order History Modal
        function showCustomerHistory(customerId) {
            const customers = RestaurantDB.customers.getAll();
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const orderHistory = RestaurantDB.customers.getOrderHistory(customerId);
            
            // Customer Profile
            document.getElementById('customerProfile').innerHTML = `
                <h2>👤 ${customer.name}</h2>
                <div class="customer-stats">
                    <div class="customer-stat">
                        <div class="customer-stat-value">${customer.totalOrders}</div>
                        <div class="customer-stat-label">Total Orders</div>
                    </div>
                    <div class="customer-stat">
                        <div class="customer-stat-value">₹${customer.totalSpent.toFixed(0)}</div>
                        <div class="customer-stat-label">Total Spent</div>
                    </div>
                    <div class="customer-stat">
                        <div class="customer-stat-value">₹${customer.totalOrders > 0 ? (customer.totalSpent / customer.totalOrders).toFixed(0) : 0}</div>
                        <div class="customer-stat-label">Avg per Order</div>
                    </div>
                    ${customer.lastVisit ? `
                        <div class="customer-stat">
                            <div class="customer-stat-value">${new Date(customer.lastVisit).toLocaleDateString()}</div>
                            <div class="customer-stat-label">Last Visit</div>
                        </div>
                    ` : ''}
                </div>
                <div style="margin-top: 1rem;">
                    <p><strong>Phone:</strong> ${customer.phone}</p>
                    <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                    <p><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                    <p><strong>Member Since:</strong> ${new Date(customer.created).toLocaleDateString()}</p>
                </div>
            `;

            // Order History
            const orderHistoryContainer = document.getElementById('orderHistoryList');
            if (orderHistory.length === 0) {
                orderHistoryContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <h3>No Orders Yet</h3>
                        <p>This customer hasn't placed any orders yet</p>
                    </div>
                `;
            } else {
                orderHistoryContainer.innerHTML = orderHistory.map(bill => `
                    <div class="order-history-item">
                        <div class="order-date">
                            <strong>${new Date(bill.date).toLocaleString()}</strong>
                            <span style="margin-left: 1rem;">Bill #${bill.id.toString().slice(-6)}</span>
                            <span style="margin-left: 1rem;">${bill.tableNumber}</span>
                        </div>
                        <div class="order-items">
                            ${bill.items.map(item => `
                                <div class="order-item">
                                    <span>${item.name} x${item.quantity}</span>
                                    <span>₹${item.total.toFixed(2)}</span>
                                </div>
                            `).join('')}
                            ${bill.roomCharge > 0 ? `
                                <div class="order-item">
                                    <span>Room Charge</span>
                                    <span>₹${bill.roomCharge.toFixed(2)}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="order-total">
                            Total: ₹${bill.total.toFixed(2)}
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-primary" onclick="viewBillDetails(${bill.id})">
                                <span class="material-icons-outlined">visibility</span>
                                View Bill
                            </button>
                            <button class="btn btn-sm btn-success" onclick="printBill(${bill.id})">
                                <span class="material-icons-outlined">print</span>
                                Print
                            </button>
                            ${bill.customerPhone ? `
                                <button class="btn btn-sm whatsapp-btn" onclick="shareOnWhatsApp(${bill.id})">
                                    <span class="material-icons-outlined">chat</span>
                                    WhatsApp
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-info" onclick="shareBill(${bill.id})">
                                <span class="material-icons-outlined">share</span>
                                Share
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('customerHistoryModal').classList.add('show');
        }

        function closeCustomerHistoryModal() {
            document.getElementById('customerHistoryModal').classList.remove('show');
        }

        function createBillForCustomer(customerId) {
            const customers = RestaurantDB.customers.getAll();
            const customer = customers.find(c => c.id === customerId);
            
            switchTab('billing');
            setTimeout(() => {
                showNewBillForm();
                setTimeout(() => {
                    document.getElementById('customerSearchInput').value = customer.name;
                    document.getElementById('selectedCustomerId').value = customerId;
                    document.getElementById('customerContactInput').value = customer.phone || customer.email || '';
                    selectedCustomerData = {
                        id: customerId,
                        name: customer.name,
                        contact: customer.phone || customer.email || customer.address || ''
                    };
                    showCustomerDetails(customerId, customer.name, customer.phone || customer.email || '');
                }, 100);
            }, 300);
        }

        // History Functions
        function loadHistory() {
            const history = RestaurantDB.history.getAll();
            const container = document.getElementById('historyTimeline');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <h3>No History Yet</h3>
                        <p>Activity history will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map(entry => `
                <div class="history-item" data-history-id="${entry.id}">
                    <div class="history-icon">
                        <span class="material-icons-outlined">${entry.icon}</span>
                    </div>
                    <div class="history-content">
                        <div class="history-title">${entry.title}</div>
                        <div class="history-details">${entry.details}</div>
                        <div class="history-time">${new Date(entry.timestamp).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');

            const searchQuery = document.getElementById('historySearchInput').value;
            if (searchQuery) {
                filterHistory();
            }
        }

        function clearAllHistory() {
            if (confirm('Clear all history? This cannot be undone.')) {
                RestaurantDB.history.clear();
                loadHistory();
                showNotification('History cleared successfully!');
            }
        }

        // Notification System
        function showNotification(message, type = 'success') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            updateContextStats('tables');
            loadTables();
            
            setTimeout(() => {
                if (document.getElementById('customerSearchInput')) {
                    setupCustomerSearch();
                }
                if (document.getElementById('dishSearchInput')) {
                    setupDishSearch();
                }
            }, 100);
        });

        // Service Worker Registration for Offline Support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
                const CACHE = 'thynk-pos-v1.81-enhanced-bills-history';
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE).then(cache => cache.addAll(['/'])));
                });
                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(response => response || fetch(e.request)));
                });
            `], {type: 'application/javascript'})))
            .then(() => console.log('PWA Service Worker registered for v1.81 with enhanced bills history and fixed room stats'));
        }
    </script>
</body>
</html>
